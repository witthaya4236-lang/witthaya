<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏´‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏•‡∏¥‡πâ‡∏ô‡∏ä‡∏≤ & ‡∏ô‡πâ‡∏≥‡∏ä‡∏á - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Prompt', sans-serif; }
        .cart-drawer { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); transform: translateY(100%); }
        .cart-drawer.open { transform: translateY(0); }
        .modal-animate { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); transform: scale(0.9); opacity: 0; }
        .modal-animate.show { transform: scale(1); opacity: 1; }
        .loading-shimmer {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        /* --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç CSS ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå --- */
        #print-area {
            display: none; /* ‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥ */
        }

        @media print {
            @page {
                size: 80mm auto; /* ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏™‡∏•‡∏¥‡∏õ */
                margin: 0;
            }
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area {
                display: block; /* ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå */
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            .no-print { display: none !important; }
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .new-order-pulse { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        
        .spice-radio:checked + label {
            background-color: #fef2f2;
            border-color: #ef4444;
            color: #b91c1c;
        }
        .spice-radio:checked + label .spice-dot { display: block; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">

    <!-- Offline Warning Banner -->
    <div id="local-warning" class="hidden bg-yellow-500 text-white text-center py-2 text-xs font-bold no-print z-50 relative px-4">
        ‚ö†Ô∏è ‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏≥‡∏•‡∏≠‡∏á (Offline): ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä | <span id="current-url-display"></span>
    </div>

    <!-- Navigation Tab (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™) -->
    <div id="main-nav" class="fixed top-0 left-0 right-0 z-[60] flex justify-center p-2 pointer-events-none no-print mt-2 transition-opacity duration-300">
        <div class="bg-black/80 backdrop-blur-md text-white rounded-full p-1 flex gap-1 pointer-events-auto shadow-xl border border-white/20">
            <button onclick="switchView('customer')" id="tab-customer" class="px-5 py-2 rounded-full text-xs font-bold transition-all bg-red-600 shadow-lg">
                <i data-lucide="users" class="w-3 h-3 inline mr-1"></i> ‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            </button>
            <button onclick="switchView('admin')" id="tab-admin" class="px-5 py-2 rounded-full text-xs font-bold transition-all hover:bg-white/10">
                <i data-lucide="settings" class="w-3 h-3 inline mr-1"></i> ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
            </button>
        </div>
    </div>

    <!-- CUSTOMER VIEW -->
    <div id="customer-view" class="pt-10 no-print">
        <header class="bg-red-600 text-white p-4 sticky top-0 z-40 shadow-lg pb-6 rounded-b-[30px] -mt-10 pt-14">
            <div class="max-w-md mx-auto flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold">‡∏´‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏•‡∏¥‡πâ‡∏ô‡∏ä‡∏≤ & ‡∏ô‡πâ‡∏≥‡∏ä‡∏á</h1>
                    <p class="text-xs text-red-100 flex items-center gap-1 font-bold bg-red-700/50 py-1 px-3 rounded-full w-fit mt-1">
                        <i data-lucide="map-pin" class="w-3 h-3"></i> <span id="display-table-no">‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà --</span>
                    </p>
                </div>
                <button onclick="toggleCart()" class="relative p-3 bg-white/20 rounded-full hover:bg-white/30 transition-all">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                    <span id="cart-badge" class="hidden absolute -top-1 -right-1 bg-yellow-400 text-red-900 text-[10px] font-bold w-5 h-5 items-center justify-center rounded-full border-2 border-red-600 shadow-sm">0</span>
                </button>
            </div>
        </header>

        <main class="max-w-md mx-auto pb-24 px-4 pt-6">
            <!-- Promotion Banner -->
            <div class="mb-6">
                <div class="bg-gradient-to-r from-red-600 to-orange-500 rounded-3xl p-6 text-white shadow-lg shadow-orange-200 relative overflow-hidden">
                    <div class="relative z-10">
                        <h2 class="text-2xl font-bold mb-1 text-white">‡∏´‡∏≠‡∏° ‡πÅ‡∏ã‡πà‡∏ö ‡πÄ‡∏ú‡πá‡∏î‡∏ä‡∏≤!</h2>
                        <p class="text-sm opacity-90 text-white">‡∏™‡∏±‡πà‡∏á‡πÄ‡∏•‡∏¢! ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏±‡∏ô‡πÑ‡∏ß ‡πÑ‡∏î‡πâ‡πÑ‡∏ß‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô</p>
                    </div>
                    <i data-lucide="flame" class="absolute -right-4 -bottom-4 w-24 h-24 text-white/10 rotate-12"></i>
                </div>
            </div>

            <!-- Category Selector -->
            <div class="flex gap-2 mb-6 sticky top-[80px] bg-gray-50/95 backdrop-blur py-2 z-30 font-bold -mx-4 px-4 overflow-x-auto no-scrollbar">
                <button onclick="filterMenu('mala')" id="btn-mala" class="flex-1 min-w-[100px] flex items-center justify-center gap-2 py-3 rounded-2xl bg-red-600 text-white shadow-md shadow-red-200 transition-all active:scale-95">
                    <i data-lucide="flame" class="w-4 h-4"></i> ‡∏´‡∏°‡∏≤‡∏•‡πà‡∏≤
                </button>
                <button onclick="filterMenu('drinks')" id="btn-drinks" class="flex-1 min-w-[100px] flex items-center justify-center gap-2 py-3 rounded-2xl bg-white text-gray-500 border border-gray-200 shadow-sm transition-all active:scale-95 hover:bg-gray-100">
                    <i data-lucide="coffee" class="w-4 h-4"></i> ‡∏ô‡πâ‡∏≥‡∏ä‡∏á
                </button>
            </div>

            <div id="menu-container" class="space-y-4 min-h-[300px]">
                <div class="py-20 text-center text-gray-400 animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢...</div>
            </div>
        </main>
    </div>

    <!-- SELECTION MODAL -->
    <div id="selection-modal" class="fixed inset-0 z-[70] flex items-end sm:items-center justify-center p-0 sm:p-6 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeSelectionModal()"></div>
        <div class="bg-white rounded-t-[32px] sm:rounded-[32px] p-6 w-full max-w-sm relative z-10 modal-animate h-[90vh] sm:h-auto overflow-y-auto flex flex-col" id="selection-content">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6 sm:hidden shrink-0"></div>
            
            <div class="flex-1 overflow-y-auto no-scrollbar pb-4">
                <div class="flex gap-4 mb-6">
                    <img id="modal-img" src="" class="w-24 h-24 rounded-2xl object-cover bg-gray-100 shadow-sm">
                    <div>
                        <h3 id="modal-title" class="text-xl font-bold text-gray-800 leading-tight mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</h3>
                        <p id="modal-price" class="text-red-600 text-lg font-bold">‡∏ø0</p>
                    </div>
                </div>

                <div id="modal-spice-section" class="mb-6 hidden">
                    <label class="block text-sm font-bold text-gray-700 mb-3">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ú‡πá‡∏î <span class="text-red-500">*</span></label>
                    <div class="space-y-2">
                        <input type="radio" name="spice" id="spice-no" value="‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î" class="hidden spice-radio" onchange="updateModalState()">
                        <label for="spice-no" class="flex items-center justify-between p-3 rounded-xl border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all">
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center">
                                    <span class="spice-dot w-2.5 h-2.5 rounded-full bg-red-500 hidden"></span>
                                </span> 
                                ‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î
                            </div>
                            <i data-lucide="sun" class="w-4 h-4 text-yellow-500"></i>
                        </label>

                        <input type="radio" name="spice" id="spice-mid" value="‡πÄ‡∏ú‡πá‡∏î‡∏Å‡∏•‡∏≤‡∏á" class="hidden spice-radio" onchange="updateModalState()">
                        <label for="spice-mid" class="flex items-center justify-between p-3 rounded-xl border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all">
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center">
                                    <span class="spice-dot w-2.5 h-2.5 rounded-full bg-red-500 hidden"></span>
                                </span> 
                                ‡πÄ‡∏ú‡πá‡∏î‡∏Å‡∏•‡∏≤‡∏á
                            </div>
                            <i data-lucide="flame" class="w-4 h-4 text-orange-500"></i>
                        </label>

                        <input type="radio" name="spice" id="spice-high" value="‡πÄ‡∏ú‡πá‡∏î‡∏°‡∏≤‡∏Å" class="hidden spice-radio" onchange="updateModalState()">
                        <label for="spice-high" class="flex items-center justify-between p-3 rounded-xl border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all">
                            <div class="flex items-center gap-2">
                                <span class="w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center">
                                    <span class="spice-dot w-2.5 h-2.5 rounded-full bg-red-500 hidden"></span>
                                </span> 
                                ‡πÄ‡∏ú‡πá‡∏î‡∏°‡∏≤‡∏Å
                            </div>
                            <div class="flex"><i data-lucide="flame" class="w-4 h-4 text-red-600"></i><i data-lucide="flame" class="w-4 h-4 text-red-600"></i></div>
                        </label>
                    </div>
                </div>

                <div class="mb-2">
                    <label class="block text-sm font-bold text-gray-700 mb-2 flex justify-between">
                        ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                        <span class="text-xs text-gray-400 font-normal">‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ú‡∏±‡∏Å, ‡∏´‡∏ß‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢</span>
                    </label>
                    <textarea id="modal-note" rows="2" class="w-full p-4 rounded-xl border border-gray-200 focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none text-sm bg-gray-50" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
                </div>
            </div>

            <div class="pt-4 border-t border-gray-100 mt-auto shrink-0">
                <div class="flex items-center justify-between gap-4">
                    <div class="flex items-center bg-gray-100 rounded-xl p-1">
                        <button onclick="adjustModalQty(-1)" class="w-10 h-10 flex items-center justify-center bg-white rounded-lg shadow-sm text-gray-600 hover:text-red-600 disabled:opacity-50 transition-all active:scale-90"><i data-lucide="minus" class="w-4 h-4"></i></button>
                        <span id="modal-qty-display" class="w-10 text-center font-bold text-lg text-gray-800">1</span>
                        <button onclick="adjustModalQty(1)" class="w-10 h-10 flex items-center justify-center bg-white rounded-lg shadow-sm text-gray-600 hover:text-green-600 transition-all active:scale-90"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <button onclick="confirmSelection()" id="modal-add-btn" class="flex-1 bg-red-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-red-200 active:scale-95 transition-all flex justify-center items-center gap-2">
                        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ - ‡∏ø<span id="modal-total-price">0</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN VIEW -->
    <div id="admin-view" class="hidden pt-16 max-w-5xl mx-auto p-4 no-print pb-20">
        <!-- Admin Navigation -->
        <div class="flex gap-2 mb-6 bg-white p-2 rounded-3xl shadow-sm overflow-x-auto no-scrollbar sticky top-16 z-30">
            <button onclick="switchAdminTab('orders')" id="admin-tab-orders" class="min-w-[110px] flex-1 py-3 rounded-2xl font-bold text-xs flex items-center justify-center gap-1 bg-red-600 text-white shadow-md transition-all">
                <i data-lucide="clipboard-list" class="w-4 h-4"></i> ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
                <span id="order-count-badge" class="hidden bg-white text-red-600 px-1.5 py-0.5 rounded-full text-[10px] shadow-sm">0</span>
            </button>
            <button onclick="switchAdminTab('accounting')" id="admin-tab-accounting" class="min-w-[110px] flex-1 py-3 rounded-2xl font-bold text-xs flex items-center justify-center gap-1 bg-gray-50 text-gray-500 hover:bg-gray-100">
                <i data-lucide="pie-chart" class="w-4 h-4"></i> ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
            </button>
            <button onclick="switchAdminTab('menu')" id="admin-tab-menu" class="min-w-[110px] flex-1 py-3 rounded-2xl font-bold text-xs flex items-center justify-center gap-1 bg-gray-50 text-gray-500 hover:bg-gray-100">
                <i data-lucide="layout-grid" class="w-4 h-4"></i> ‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£
            </button>
            <button onclick="switchAdminTab('qr')" id="admin-tab-qr" class="min-w-[110px] flex-1 py-3 rounded-2xl font-bold text-xs flex items-center justify-center gap-1 bg-gray-50 text-gray-500 hover:bg-gray-100">
                <i data-lucide="qr-code" class="w-4 h-4"></i> QR ‡πÇ‡∏ï‡πä‡∏∞
            </button>
        </div>

        <!-- Section: Orders -->
        <div id="section-orders" class="space-y-4">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-3xl font-black text-gray-800 uppercase tracking-tighter">‡∏Ñ‡∏£‡∏±‡∏ß & ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß</h2>
                    <p class="text-xs text-gray-400">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î)</p>
                </div>
                <button onclick="window.testSound()" class="p-3 bg-white border border-gray-100 rounded-2xl shadow-sm text-gray-400 hover:text-red-500 transition-all active:scale-90">
                    <i data-lucide="volume-2"></i>
                </button>
            </div>
            <div id="orders-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Orders will be injected here -->
            </div>
        </div>

        <!-- Section: Accounting -->
        <div id="section-accounting" class="hidden space-y-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2>
                <button onclick="window.exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded-2xl text-xs font-bold flex items-center gap-2 shadow-sm hover:bg-green-700 active:scale-95 transition-all">
                    <i data-lucide="download" class="w-4 h-4"></i> Export CSV
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-6 rounded-[32px] shadow-sm border border-gray-100"><p class="text-gray-400 text-[10px] font-bold uppercase mb-2">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÅ‡∏•‡πâ‡∏ß)</p><p id="total-income" class="text-3xl font-black text-green-600">‡∏ø0</p></div>
                <div class="bg-white p-6 rounded-[32px] shadow-sm border border-gray-100"><p class="text-gray-400 text-[10px] font-bold uppercase mb-2">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</p><p id="total-expense" class="text-3xl font-black text-red-600">‡∏ø0</p></div>
                <div class="bg-white p-6 rounded-[32px] shadow-sm border border-gray-100"><p class="text-gray-400 text-[10px] font-bold uppercase mb-2">‡∏Å‡∏≥‡πÑ‡∏£</p><p id="total-profit" class="text-3xl font-black text-blue-600">‡∏ø0</p></div>
            </div>

            <!-- New Section: Past Orders -->
            <div class="bg-white rounded-[40px] shadow-sm border border-gray-100 p-8 overflow-hidden">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i data-lucide="history" class="text-gray-800"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå / ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
                <div class="overflow-y-auto max-h-80 no-scrollbar">
                    <table class="w-full text-left font-bold text-sm">
                        <thead><tr class="text-gray-400 text-[10px] border-b border-gray-50 font-black"><th class="pb-3">‡πÄ‡∏ß‡∏•‡∏≤</th><th class="pb-3 text-center">‡πÇ‡∏ï‡πä‡∏∞</th><th class="pb-3 text-center">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</th><th class="pb-3 text-right">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</th></tr></thead>
                        <tbody id="order-history-list"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-[40px] shadow-sm border border-gray-100 p-8">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i data-lucide="plus-circle" class="text-red-600"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h3>
                <form id="expense-form" class="flex flex-col md:flex-row gap-3">
                    <input type="text" id="expense-title" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á)" class="flex-1 px-5 py-3 rounded-2xl border-2 border-gray-50 outline-none focus:border-red-500 font-bold bg-gray-50 focus:bg-white transition-all" required>
                    <input type="number" id="expense-amount" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" class="w-full md:w-32 px-5 py-3 rounded-2xl border-2 border-gray-50 outline-none focus:border-red-500 font-bold bg-gray-50 focus:bg-white transition-all" required>
                    <button type="submit" class="bg-gray-900 text-white px-8 py-3 rounded-2xl font-bold shadow-lg hover:bg-black transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </form>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-[40px] shadow-sm border border-gray-100 p-8 overflow-hidden">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i data-lucide="list" class="text-gray-800"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢)</h3>
                    <div class="overflow-y-auto max-h-80 no-scrollbar">
                        <table class="w-full text-left font-bold text-sm">
                            <thead><tr class="text-gray-400 text-[10px] border-b border-gray-50 font-black"><th class="pb-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th class="pb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="pb-3 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="pb-3"></th></tr></thead>
                            <tbody id="transaction-list"></tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-white rounded-[40px] shadow-sm border border-gray-100 p-8 overflow-hidden">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i data-lucide="bar-chart-2" class="text-red-600"></i> ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡πÄ‡∏°‡∏ô‡∏π</h3>
                    <div class="overflow-y-auto max-h-80 no-scrollbar">
                        <table class="w-full text-left font-bold text-sm">
                            <thead><tr class="text-gray-400 text-[10px] border-b border-gray-50 font-black"><th class="pb-3">‡πÄ‡∏°‡∏ô‡∏π</th><th class="pb-3 text-center">‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ä‡∏¥‡πâ‡∏ô)</th><th class="pb-3 text-right">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th></tr></thead>
                            <tbody id="sales-breakdown-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section: QR Code Generator -->
        <div id="section-qr" class="hidden space-y-6">
            <div class="bg-white rounded-[40px] shadow-sm border border-gray-100 p-8 sm:p-12 text-center">
                <h2 class="text-2xl font-black text-gray-800 mb-2 flex items-center justify-center gap-2">
                    <i data-lucide="qr-code" class="text-red-600"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå QR Code ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÇ‡∏ï‡πä‡∏∞
                </h2>
                <p class="text-gray-400 text-sm font-bold mb-8">‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÑ‡∏õ‡πÅ‡∏õ‡∏∞‡∏ó‡∏µ‡πà‡πÇ‡∏ï‡πä‡∏∞</p>

                <div class="max-w-md mx-auto mb-10 space-y-4">
                    <div class="bg-gray-50 p-4 rounded-3xl border-2 border-dashed border-gray-200">
                         <label class="text-[10px] font-black uppercase text-gray-400 mb-1 block">‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)</label>
                         <input type="text" id="qr-base-url" oninput="updateQRPreview()" class="w-full bg-transparent text-center font-bold text-blue-600 text-xs outline-none break-all" placeholder="http://...">
                    </div>

                    <div class="flex items-center justify-center gap-4">
                        <div class="flex-1">
                            <label class="text-[10px] font-black uppercase text-gray-400 mb-2 block">‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞</label>
                            <input type="text" id="qr-table-input" value="01" oninput="updateQRPreview()" class="w-full px-6 py-4 rounded-3xl border-4 border-gray-100 outline-none focus:border-red-500 text-center text-4xl font-black text-gray-800 shadow-inner">
                        </div>
                    </div>
                </div>

                <!-- Preview Card Area -->
                <div class="flex justify-center mb-10">
                    <div id="card-preview-container">
                        <!-- Table Card Design -->
                        <div class="relative w-[320px] h-[450px] border-[12px] border-red-600 rounded-[3rem] bg-white flex flex-col items-center justify-between py-10 px-4 shadow-xl">
                            <div class="text-center">
                                <h1 class="text-4xl font-black text-red-600 italic tracking-tighter" style="font-family: 'Prompt', sans-serif;">‡∏´‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏•‡∏¥‡πâ‡∏ô‡∏ä‡∏≤</h1>
                                <p class="text-xs text-gray-400 font-bold tracking-[0.4em] uppercase mt-1">MALA LIN CHA</p>
                            </div>
                            
                            <div class="bg-white p-2">
                                <img id="qr-image-preview" src="" class="w-48 h-48 mix-blend-multiply">
                            </div>
                            
                            <div class="text-center w-full">
                                <div class="bg-red-600 text-white py-3 px-10 rounded-full inline-block mb-3 shadow-md">
                                    <h2 class="text-4xl font-black" id="preview-table-no">‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà 01</h2>
                                </div>
                                <p class="text-[10px] font-black text-gray-800 uppercase tracking-widest">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‚Ä¢ SCAN TO ORDER</p>
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="window.printQRCard()" class="bg-gray-900 text-white px-10 py-4 rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg hover:bg-black transition-all mx-auto active:scale-95">
                    <i data-lucide="printer"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡πâ‡∏≤‡∏¢‡∏ô‡∏µ‡πâ
                </button>
            </div>
        </div>

        <!-- Section: Menu -->
        <div id="section-menu" class="hidden space-y-6">
            <div class="bg-white rounded-[40px] shadow-sm border border-gray-100 p-8 sm:p-10">
                <h2 class="text-2xl font-black text-gray-800 mb-8">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</h2>
                <form id="menu-form" class="space-y-4 bg-gray-50 p-6 sm:p-8 rounded-[32px] border-2 border-white shadow-sm">
                    <input type="hidden" id="edit-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2 flex flex-col items-center justify-center p-6 border-4 border-dashed border-white rounded-[32px] bg-white hover:border-red-200 cursor-pointer transition-all relative overflow-hidden group" onclick="document.getElementById('menu-file').click()">
                            <input type="file" id="menu-file" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                            <input type="hidden" id="menu-img-data">
                            <img id="image-preview" src="" class="hidden w-40 h-40 object-cover rounded-[24px] mb-4 shadow-md z-10">
                            <div id="upload-placeholder" class="text-center">
                                <i data-lucide="image-plus" class="w-10 h-10 mx-auto text-gray-200 group-hover:text-red-400 transition-colors"></i>
                                <p class="text-xs font-black text-gray-300 mt-2 uppercase tracking-tighter group-hover:text-red-400">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡πÄ‡∏°‡∏ô‡∏π</p>
                            </div>
                        </div>
                        <input type="text" id="menu-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π" class="w-full px-6 py-4 rounded-2xl border-none shadow-inner bg-white outline-none focus:ring-4 ring-red-50 font-bold text-gray-700" required>
                        <input type="number" id="menu-price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" class="w-full px-6 py-4 rounded-2xl border-none shadow-inner bg-white outline-none focus:ring-4 ring-red-50 font-bold text-gray-700" required>
                        <select id="menu-cat" class="w-full px-6 py-4 rounded-2xl border-none shadow-inner bg-white outline-none focus:ring-4 ring-red-50 font-black text-gray-700">
                            <option value="mala">‡∏´‡∏°‡∏≤‡∏•‡πà‡∏≤</option>
                            <option value="drinks">‡∏ô‡πâ‡∏≥‡∏ä‡∏á</option>
                        </select>
                        <div class="flex gap-2 md:col-span-2">
                             <button type="submit" id="form-submit" class="flex-1 bg-gray-900 text-white font-black py-4 rounded-2xl hover:bg-black transition-all shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                             <button type="button" onclick="resetForm()" class="px-6 py-4 bg-gray-200 text-gray-500 rounded-2xl font-bold hover:bg-gray-300">‡∏•‡πâ‡∏≤‡∏á</button>
                        </div>
                    </div>
                </form>
            </div>
            <div id="admin-menu-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
    </div>

    <!-- Hidden Print Area -->
    <div id="print-area"></div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-6 hidden no-print">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-md"></div>
        <div class="bg-white rounded-[60px] p-12 text-center relative z-10 w-full max-w-xs scale-90 opacity-0 transition-all duration-500" id="success-content">
            <div class="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-8 shadow-inner">
                <i data-lucide="check" class="w-12 h-12"></i>
            </div>
            <h4 class="text-3xl font-black mb-1 text-gray-800">‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß!</h4>
            <div class="bg-red-600 text-white rounded-3xl py-4 my-6 shadow-lg shadow-red-200">
                <p class="text-xs font-bold uppercase opacity-80 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                <p id="customer-queue-no" class="text-6xl font-black">#--</p>
            </div>
            <p class="text-gray-400 text-sm font-bold mb-8 italic">‡πÄ‡∏ä‡∏ü‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏≥‡∏à‡πâ‡∏≤<br>‡∏£‡∏≠‡∏ü‡∏±‡∏á‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!</p>
            <button onclick="closeSuccess()" class="w-full py-5 bg-gray-900 text-white rounded-[32px] font-black text-xl active:scale-95 transition-all shadow-xl">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>
    </div>

    <!-- Cart Drawer -->
    <div id="cart-overlay" onclick="toggleCart()" class="fixed inset-0 bg-black/50 z-40 hidden opacity-0 transition-opacity no-print backdrop-blur-sm"></div>
    <div id="cart-drawer" class="cart-drawer fixed bottom-0 left-0 right-0 bg-white z-50 rounded-t-[50px] max-h-[90vh] flex flex-col shadow-2xl no-print">
        <div class="p-8 pb-4 flex justify-between items-center bg-white rounded-t-[50px] sticky top-0 z-10">
            <h3 class="text-3xl font-black text-gray-800">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</h3>
            <button onclick="toggleCart()" class="p-3 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors"><i data-lucide="x" class="text-gray-500 w-6 h-6"></i></button>
        </div>
        
        <div class="px-8 overflow-y-auto font-bold flex-1 no-scrollbar pb-8">
            <div id="cart-items" class="space-y-4 mb-8"></div>
            
            <div id="cart-empty" class="text-center py-20 text-gray-300 font-black italic tracking-widest uppercase flex flex-col items-center">
                <i data-lucide="shopping-basket" class="w-16 h-16 mb-4 opacity-20"></i>
                ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤...
            </div>
        </div>
        
        <div class="p-8 border-t-4 border-gray-50 bg-white pb-10">
            <div class="flex justify-between items-center mb-6">
                <span class="text-gray-400 font-black uppercase text-xs">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</span>
                <span id="cart-total" class="text-4xl font-black text-red-600">‡∏ø0</span>
            </div>
            <button onclick="placeOrder()" id="checkout-btn" class="w-full bg-red-600 text-white py-6 rounded-[35px] font-black text-2xl shadow-2xl shadow-red-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                ‡∏™‡∏±‡πà‡∏á‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢! <i data-lucide="arrow-right" class="w-6 h-6"></i>
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, addDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app, auth, db;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Firebase Init ---
        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                const firebaseConfig = JSON.parse(__firebase_config);
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch (error) { console.warn("Offline Mode Active"); }

        // --- State ---
        let user = null;
        let menuItems = [];
        let allOrders = [];
        let transactions = [];
        let cart = [];
        let currentFilter = 'mala';
        let isInitialOrdersLoad = true;
        
        // Modal State
        let currentModalItem = null;
        let modalQty = 1;
        let modalSpice = null;

        // URL Params for Table
        const urlParams = new URLSearchParams(window.location.search);
        let tableNo = urlParams.get('table') || "‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ñ‡∏≤‡∏ô‡πå‡πÄ‡∏ï‡∏≠‡∏£‡πå";
        
        // Check if customer mode (Scan QR)
        if (urlParams.get('table')) {
            // Strictly hide Back Office controls
            const nav = document.getElementById('main-nav');
            if (nav) nav.remove(); // Remove navigation bar completely
            
            // Hide debug warning for customers
            const warning = document.getElementById('local-warning');
            if (warning) warning.style.display = 'none';
        }

        document.getElementById('display-table-no').innerText = `‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà ${tableNo}`;

        const playNotificationSound = () => {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator(); 
            const gainNode = audioCtx.createGain();
            oscillator.type = 'sine'; 
            oscillator.frequency.setValueAtTime(500, audioCtx.currentTime); 
            oscillator.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime); 
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            oscillator.connect(gainNode); 
            gainNode.connect(audioCtx.destination); 
            oscillator.start(); 
            oscillator.stop(audioCtx.currentTime + 0.5);
        };
        window.testSound = () => playNotificationSound();

        // --- STARTUP LOGIC ---
        function initApp() {
            if (!db) {
                // Offline Mode
                document.getElementById('local-warning').classList.remove('hidden');
                document.getElementById('current-url-display').innerText = window.location.host;
                
                // Seed Fake Data
                menuItems = [
                    { id: '1', cat: 'mala', name: '‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠‡∏´‡∏°‡∏π', price: 15, img: 'https://images.unsplash.com/photo-1544025162-d76694265947?w=400', desc: '‡∏´‡∏°‡∏π‡∏ô‡∏∏‡πà‡∏°' },
                    { id: '2', cat: 'mala', name: '‡πÄ‡∏ö‡∏Ñ‡∏≠‡∏ô‡∏û‡∏±‡∏ô‡πÄ‡∏´‡πá‡∏î', price: 20, img: 'https://images.unsplash.com/photo-1603360946369-dc9bb6258143?w=400', desc: '‡∏≠‡∏£‡πà‡∏≠‡∏¢' },
                    { id: '3', cat: 'mala', name: '‡∏ü‡∏≠‡∏á‡πÄ‡∏ï‡πâ‡∏≤‡∏´‡∏π‡πâ‡∏ã‡∏µ‡∏ü‡∏π‡πâ‡∏î', price: 25, img: 'https://images.unsplash.com/photo-1563245372-f21724e3856d?w=400', desc: '‡πÄ‡∏î‡πâ‡∏á‡∏î‡∏∂‡πã‡∏á' },
                    { id: '4', cat: 'drinks', name: '‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢', price: 45, img: 'https://images.unsplash.com/photo-1576092768241-dec231879fc3?w=400', desc: '‡∏´‡∏≠‡∏°' },
                    { id: '5', cat: 'drinks', name: '‡∏ô‡∏°‡∏ä‡∏°‡∏û‡∏π', price: 40, img: 'https://images.unsplash.com/photo-1556679343-c7306c1976bc?w=400', desc: '‡∏´‡∏ß‡∏≤‡∏ô‡∏°‡∏±‡∏ô' }
                ];
                renderMenu(); 
                renderAdminMenu(); 
                renderAdminOrders([]); 
                updateAccountingSummary();
                updateQRPreview(); // Init QR
                
            } else {
                // Online Mode
                const initAuth = async () => { 
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) 
                        await signInWithCustomToken(auth, __initial_auth_token); 
                    else 
                        await signInAnonymously(auth); 
                };
                initAuth();
                onAuthStateChanged(auth, (u) => { 
                    user = u; 
                    if (user) { 
                        setupRealtimeMenu(); 
                        setupRealtimeOrders(); 
                        setupRealtimeAccounting();
                        updateQRPreview(); // Init QR
                    } 
                });
            }
            if(window.lucide) lucide.createIcons();
        }

        // --- Firebase Handlers ---
        let menuCollection, ordersCollection, transactionsCollection;
        if (db) {
            menuCollection = collection(db, 'artifacts', appId, 'public', 'data', 'menu');
            ordersCollection = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
            transactionsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
        }

        function setupRealtimeMenu() {
            onSnapshot(menuCollection, (snapshot) => {
                menuItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (menuItems.length === 0) seedDefaultData();
                renderMenu(); renderAdminMenu();
            });
        }

        function setupRealtimeOrders() {
            onSnapshot(ordersCollection, (snapshot) => {
                const newOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.timestamp - b.timestamp);
                if (!isInitialOrdersLoad) {
                    const hasNewPending = snapshot.docChanges().some(change => change.type === "added" && change.doc.data().status === 'pending');
                    if (hasNewPending) playNotificationSound();
                }
                isInitialOrdersLoad = false; 
                allOrders = newOrders; 
                renderAdminOrders(allOrders); 
                updateAccountingSummary();
                
                // Update Badge
                const pendingCount = allOrders.filter(o => o.status === 'pending').length;
                const badge = document.getElementById('order-count-badge');
                if (pendingCount > 0) { badge.innerText = pendingCount; badge.classList.remove('hidden'); } 
                else badge.classList.add('hidden');
            });
        }

        function setupRealtimeAccounting() {
            onSnapshot(transactionsCollection, (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.timestamp - a.timestamp);
                updateAccountingSummary();
            });
        }

        async function seedDefaultData() {
            if (!db) return;
            const defaults = [ 
                { cat: 'mala', name: '‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠‡∏´‡∏°‡∏π', price: 15, img: 'https://images.unsplash.com/photo-1544025162-d76694265947?w=400' }, 
                { cat: 'drinks', name: '‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢', price: 45, img: 'https://images.unsplash.com/photo-1576092768241-dec231879fc3?w=400' } 
            ];
            for (const item of defaults) await addDoc(menuCollection, item);
        }

        // --- Admin Logic ---
        function updateAccountingSummary() {
            const income = allOrders.filter(o => o.status === 'completed').reduce((sum, o) => sum + o.total, 0);
            const expense = transactions.reduce((sum, t) => sum + t.amount, 0);
            const profit = income - expense;
            
            document.getElementById('total-income').innerText = `‡∏ø${income.toLocaleString()}`;
            document.getElementById('total-expense').innerText = `‡∏ø${expense.toLocaleString()}`;
            document.getElementById('total-profit').innerText = `‡∏ø${profit.toLocaleString()}`;
            
            renderTransactionsList(income);
            
            // Sales breakdown
            const completedOrders = allOrders.filter(o => o.status === 'completed');
            const itemStats = {};
            completedOrders.forEach(order => {
                order.items.forEach(item => {
                    if (!itemStats[item.name]) itemStats[item.name] = { qty: 0, total: 0 };
                    itemStats[item.name].qty += item.qty;
                    itemStats[item.name].total += (item.price * item.qty);
                });
            });
            const sortedItems = Object.keys(itemStats).map(name => ({ name, qty: itemStats[name].qty, total: itemStats[name].total })).sort((a, b) => b.qty - a.qty);
            renderSalesBreakdown(sortedItems);
            
            // Render Order History (New Feature)
            renderOrderHistory(completedOrders);
        }

        function renderOrderHistory(completedOrders) {
            const list = document.getElementById('order-history-list');
            // Sort by timestamp desc
            const sorted = [...completedOrders].sort((a,b) => b.timestamp - a.timestamp);
            
            if(sorted.length === 0) { list.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</td></tr>`; return; }
            
            list.innerHTML = sorted.map(order => `
                <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors text-gray-700">
                    <td class="py-3 pl-2">${new Date(order.timestamp).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'})}</td>
                    <td class="py-3 text-center">${order.table}</td>
                    <td class="py-3 text-center font-bold text-green-600">‡∏ø${order.total.toLocaleString()}</td>
                    <td class="py-3 text-right pr-2">
                        <button onclick="window.printOrderReceipt('${order.id}')" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-xl text-gray-600 transition-colors" title="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à">
                            <i data-lucide="printer" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            if(window.lucide) lucide.createIcons();
        }

        function renderSalesBreakdown(items) {
            const list = document.getElementById('sales-breakdown-list');
            if(items.length === 0) { list.innerHTML = `<tr><td colspan="3" class="text-center py-8 text-gray-400 font-bold">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</td></tr>`; return; }
            list.innerHTML = items.map(item => `
                <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors text-gray-700">
                    <td class="py-4 pl-2">${item.name}</td>
                    <td class="py-4 text-center text-blue-600 font-black">${item.qty}</td>
                    <td class="py-4 text-right text-green-600 font-black pr-2">‡∏ø${item.total.toLocaleString()}</td>
                </tr>`).join('');
        }

        function renderTransactionsList(totalIncome) {
            const list = document.getElementById('transaction-list');
            const salesRow = `<tr class="border-b border-gray-50 bg-green-50/30 text-green-600 font-black"><td class="p-4 rounded-l-xl">‚úÖ</td><td>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏°</td><td class="text-right pr-4 rounded-r-xl">‡∏ø${totalIncome.toLocaleString()}</td><td></td></tr>`;
            const expenseRows = transactions.map(t => `
                <tr class="border-b border-gray-50 text-gray-700 hover:bg-red-50/10 transition-colors">
                    <td class="p-4 font-black">üí∏</td>
                    <td>${t.title}</td>
                    <td class="text-right text-red-500 font-bold">‡∏ø${t.amount.toLocaleString()}</td>
                    <td class="text-right">
                        <button onclick="window.deleteTransaction('${t.id}')" class="text-gray-300 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>`).join('');
            list.innerHTML = salesRow + expenseRows; 
            if(window.lucide) lucide.createIcons();
        }

        // --- Core Functions ---
        window.switchView = (v) => {
            const cv = document.getElementById('customer-view'); 
            const av = document.getElementById('admin-view');
            const tc = document.getElementById('tab-customer'); 
            const ta = document.getElementById('tab-admin');
            
            if (v === 'admin') { 
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                const isAdmin = sessionStorage.getItem('isAdmin');
                if (!isAdmin) {
                    const pass = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏´‡∏±‡∏™: 1234)"); 
                    if (pass === '1234') {
                        sessionStorage.setItem('isAdmin', 'true');
                    } else {
                        alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                        return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                    }
                }

                cv.classList.add('hidden'); av.classList.remove('hidden'); 
                ta.classList.add('bg-red-600', 'shadow-lg'); ta.classList.remove('hover:bg-white/10');
                tc.classList.remove('bg-red-600', 'shadow-lg'); tc.classList.add('hover:bg-white/10');
            } else { 
                cv.classList.remove('hidden'); av.classList.add('hidden'); 
                tc.classList.add('bg-red-600', 'shadow-lg'); tc.classList.remove('hover:bg-white/10');
                ta.classList.remove('bg-red-600', 'shadow-lg'); ta.classList.add('hover:bg-white/10');
            }
        };

        window.filterMenu = (cat) => {
            currentFilter = cat; 
            const btnMala = document.getElementById('btn-mala'); 
            const btnDrinks = document.getElementById('btn-drinks');
            
            // Reset Classes
            const activeClass = "flex-1 min-w-[100px] flex items-center justify-center gap-2 py-3 rounded-2xl bg-red-600 text-white shadow-md shadow-red-200 transition-all active:scale-95";
            const inactiveClass = "flex-1 min-w-[100px] flex items-center justify-center gap-2 py-3 rounded-2xl bg-white text-gray-500 border border-gray-200 shadow-sm transition-all active:scale-95 hover:bg-gray-100";
            
            if (cat === 'mala') { 
                btnMala.className = activeClass; 
                btnDrinks.className = inactiveClass; 
            } else { 
                btnDrinks.className = activeClass; 
                btnMala.className = inactiveClass; 
            }
            renderMenu();
        };

        function renderMenu() {
            const container = document.getElementById('menu-container');
            const items = menuItems.filter(item => item.cat === currentFilter);
            
            if (items.length === 0) { 
                container.innerHTML = `<div class="py-20 text-center text-gray-400 font-black italic uppercase flex flex-col items-center"><i data-lucide="utensils-crossed" class="w-12 h-12 mb-3 opacity-20"></i>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</div>`; 
                if(window.lucide) lucide.createIcons();
                return; 
            }
            
            container.innerHTML = items.map(item => `
                <div class="bg-white p-4 rounded-[35px] flex gap-5 shadow-sm border-2 border-gray-50 hover:border-red-100 transition-all cursor-pointer group" onclick="window.openSelectionModal('${item.id}')">
                    <img src="${item.img}" class="w-28 h-28 rounded-[24px] object-cover bg-gray-100 shadow-inner group-hover:scale-105 transition-transform duration-300">
                    <div class="flex-1 flex flex-col justify-between py-1">
                        <div>
                            <h4 class="font-black text-gray-800 text-xl tracking-tighter leading-tight mb-1">${item.name}</h4>
                            <span class="text-red-600 font-black text-2xl">‡∏ø${item.price}</span>
                        </div>
                        <div class="self-end bg-gray-900 text-white p-3 rounded-2xl group-hover:bg-red-600 active:scale-90 transition-all shadow-md">
                            <i data-lucide="plus" class="w-6 h-6 text-white"></i>
                        </div>
                    </div>
                </div>`).join(''); 
            if(window.lucide) lucide.createIcons();
        }

        // --- Cart & Modal System ---
        window.openSelectionModal = (id) => {
            const product = menuItems.find(p => p.id === id); if (!product) return;
            currentModalItem = product; modalQty = 1; modalSpice = null;
            
            document.getElementById('modal-img').src = product.img;
            document.getElementById('modal-title').innerText = product.name;
            document.getElementById('modal-price').innerText = `‡∏ø${product.price}`;
            document.getElementById('modal-qty-display').innerText = "1";
            document.getElementById('modal-total-price').innerText = product.price;
            document.getElementById('modal-note').value = "";
            
            const spiceSection = document.getElementById('modal-spice-section');
            const spiceRadios = document.querySelectorAll('.spice-radio');
            spiceRadios.forEach(r => r.checked = false);
            
            if (product.cat === 'mala') spiceSection.classList.remove('hidden'); 
            else spiceSection.classList.add('hidden');
            
            document.getElementById('selection-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('selection-content').classList.add('show'), 10);
            if(window.lucide) lucide.createIcons();
        };

        window.closeSelectionModal = () => { 
            document.getElementById('selection-content').classList.remove('show'); 
            setTimeout(() => { document.getElementById('selection-modal').classList.add('hidden'); currentModalItem = null; }, 300); 
        };
        
        window.adjustModalQty = (delta) => { 
            if (!currentModalItem) return; 
            const newQty = modalQty + delta; 
            if (newQty < 1) return; 
            modalQty = newQty; 
            document.getElementById('modal-qty-display').innerText = modalQty; 
            document.getElementById('modal-total-price').innerText = (currentModalItem.price * modalQty).toLocaleString(); 
        };
        
        window.updateModalState = () => { 
            const radios = document.getElementsByName('spice'); 
            for(let r of radios) { if(r.checked) modalSpice = r.value; } 
        };

        window.confirmSelection = () => {
            if (!currentModalItem) return;
            if (currentModalItem.cat === 'mala') {
                const radios = document.getElementsByName('spice'); 
                let selected = null; 
                for(let r of radios) { if(r.checked) selected = r.value; }
                if (!selected) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ú‡πá‡∏î‡∏à‡πâ‡∏≤!"); return; } 
                modalSpice = selected;
            } else { modalSpice = null; }
            
            const note = document.getElementById('modal-note').value.trim();
            const existing = cart.find(item => item.id === currentModalItem.id && item.spice === modalSpice && item.note === note);
            
            if (existing) existing.qty += modalQty; 
            else cart.push({ ...currentModalItem, qty: modalQty, spice: modalSpice, note: note });
            
            updateBadge(); window.closeSelectionModal();
        };

        function updateBadge() { 
            const badge = document.getElementById('cart-badge'); 
            const total = cart.reduce((sum, item) => sum + item.qty, 0); 
            if (total > 0) { badge.innerText = total; badge.classList.replace('hidden', 'flex'); } 
            else badge.classList.replace('flex', 'hidden'); 
        }
        
        window.toggleCart = () => { 
            const drawer = document.getElementById('cart-drawer'); 
            const overlay = document.getElementById('cart-overlay'); 
            const isOpen = drawer.classList.contains('open'); 
            if (isOpen) { 
                drawer.classList.remove('open'); 
                overlay.classList.remove('opacity-100');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            } else { 
                drawer.classList.add('open'); 
                overlay.classList.remove('hidden'); 
                setTimeout(() => overlay.classList.add('opacity-100'), 10); 
                renderCart(); 
            } 
        };

        // --- Order (Payment Modal Removed) ---
        function renderCart() {
            const container = document.getElementById('cart-items'); 
            const totalEl = document.getElementById('cart-total'); 
            
            if (cart.length === 0) { 
                container.innerHTML = ''; 
                document.getElementById('cart-empty').classList.remove('hidden'); 
            } else {
                document.getElementById('cart-empty').classList.add('hidden'); 
                container.innerHTML = cart.map((item, index) => `
                    <div class="flex justify-between items-center bg-gray-50 p-4 rounded-[30px] border-2 border-white shadow-sm hover:border-red-100 transition-colors">
                        <div class="flex items-center gap-4">
                            <img src="${item.img}" class="w-16 h-16 rounded-[18px] object-cover shadow-sm bg-white">
                            <div>
                                <p class="font-black text-gray-800 tracking-tighter text-lg leading-none">${item.name}</p>
                                <div class="flex flex-wrap gap-1 mt-2">
                                    ${item.spice ? `<span class="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-black uppercase">${item.spice}</span>` : ''}
                                    ${item.note ? `<span class="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold">üìù ${item.note}</span>` : ''}
                                </div>
                                <p class="text-sm text-red-600 font-black mt-1">‡∏ø${item.price * item.qty}</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-center gap-1 bg-white p-1 rounded-2xl shadow-inner font-black border border-gray-100">
                            <button onclick="window.updateQty(${index}, 1)" class="w-8 h-8 flex items-center justify-center hover:bg-green-50 rounded-xl text-green-600 transition-colors"><i data-lucide="plus" class="w-4 h-4"></i></button>
                            <span class="text-md min-w-[20px] text-center">${item.qty}</span>
                            <button onclick="window.updateQty(${index}, -1)" class="w-8 h-8 flex items-center justify-center hover:bg-red-50 rounded-xl text-red-600 transition-colors"><i data-lucide="minus" class="w-4 h-4"></i></button>
                        </div>
                    </div>`).join('');
            }
            totalEl.innerText = `‡∏ø${cart.reduce((sum, item) => sum + (item.price * item.qty), 0).toLocaleString()}`;
            if(window.lucide) lucide.createIcons();
        }

        window.updateQty = (index, delta) => { 
            const item = cart[index]; 
            if (item) { 
                item.qty += delta; 
                if (item.qty <= 0) cart.splice(index, 1); 
            } 
            renderCart(); updateBadge(); 
        };

        window.placeOrder = () => {
            if (cart.length === 0) return;
            // Directly submit order without confirm dialog to avoid blocks
            window.submitOrder();
        };

        window.submitOrder = async () => {
            const btn = document.getElementById('checkout-btn'); 
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå...`; 
            if(window.lucide) lucide.createIcons();
            btn.disabled = true;
            
            let queueNo = 1;
            if (db) {
                try { const snapshot = await getDocs(ordersCollection); queueNo = snapshot.size + 1; } catch(e) { console.error(e); }
            } else { queueNo = Math.floor(Math.random() * 100) + 1; }
            
            const orderData = {
                queueNo: queueNo, 
                table: tableNo,
                items: cart.map(i => ({ name: i.name, spice: i.spice || null, price: i.price, qty: i.qty, note: i.note || '' })),
                total: cart.reduce((sum, item) => sum + (item.price * item.qty), 0),
                status: 'pending', 
                timestamp: Date.now()
            };
            
            try {
                if (db) await addDoc(ordersCollection, orderData);
                else { allOrders.push({ id: Date.now().toString(), ...orderData }); renderAdminOrders(allOrders); }
                
                document.getElementById('customer-queue-no').innerText = `#${queueNo}`;
                showSuccess(); 
                cart = []; 
                updateBadge();
            } catch (err) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà"); } 
            finally { 
                btn.innerHTML = `‡∏™‡∏±‡πà‡∏á‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢! <i data-lucide="arrow-right" class="w-6 h-6"></i>`; 
                btn.disabled = false; 
                if(window.lucide) lucide.createIcons();
            }
        };

        // --- Admin Functions ---
        function renderAdminOrders(orders) {
            const list = document.getElementById('orders-list');
            const activeOrders = orders.filter(o => o.status !== 'completed');
            
            if (activeOrders.length === 0) { 
                list.innerHTML = `<div class="col-span-full py-24 text-center text-gray-400 font-black border-4 border-dashed border-gray-100 rounded-[40px] flex flex-col items-center"><i data-lucide="chef-hat" class="w-16 h-16 mb-4 opacity-20"></i>‡∏Ñ‡∏£‡∏±‡∏ß‡∏ß‡πà‡∏≤‡∏á‡∏à‡πâ‡∏≤! ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</div>`; 
                if(window.lucide) lucide.createIcons();
                return; 
            }
            
            list.innerHTML = activeOrders.map((order, index) => {
                const time = new Date(order.timestamp).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                const isPending = order.status === 'pending';
                const isOverdue = (Date.now() - order.timestamp) > 300000;
                
                return `
                <div class="bg-white rounded-[45px] p-8 shadow-sm border-2 ${isPending ? 'border-red-500' : 'border-green-100'} ${isOverdue ? 'new-order-pulse' : ''} transition-all relative overflow-hidden group hover:shadow-lg">
                    <div class="flex justify-between items-start mb-6 relative z-10">
                        <div class="bg-gray-900 text-white rounded-3xl py-1.5 px-4 text-[10px] font-black uppercase tracking-widest shadow-lg">
                            ${index === 0 ? 'üî• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥' : `‚è≥ ‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà ${index + 1}`}
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="window.printOrderReceipt('${order.id}')" class="p-2 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition-colors" title="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à">
                                <i data-lucide="printer" class="w-4 h-4"></i>
                            </button>
                            <span class="text-4xl font-black text-red-600 tracking-tighter">#${order.queueNo || '--'}</span>
                        </div>
                    </div>
                    
                    <div class="mb-6 relative z-10">
                        <h3 class="text-2xl font-black text-gray-800">‡πÇ‡∏ï‡πä‡∏∞: ${order.table}</h3>
                        <p class="text-xs text-gray-400 font-bold flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${time}</p>
                    </div>
                    
                    <div class="space-y-3 mb-8 border-y-2 border-gray-50 py-5 font-black relative z-10">
                        ${order.items.map(i => `
                            <div class="flex justify-between text-lg items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <span class="text-gray-800 text-base">${i.qty}x ${i.name}</span>
                                        ${i.spice ? `<span class="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full w-fit uppercase">${i.spice}</span>`:''}
                                    </div>
                                    ${i.note ? `<p class="text-xs text-blue-600 mt-1 font-bold bg-blue-50 w-fit px-2 py-1 rounded-lg">üìù ${i.note}</p>` : ''}
                                </div>
                            </div>`).join('')}
                    </div>
                    
                    <div class="flex gap-2 relative z-10">
                        ${isPending 
                            ? `<button onclick="window.updateOrderStatus('${order.id}', 'cooking')" class="flex-1 bg-gray-900 text-white py-4 rounded-[24px] font-black shadow-lg shadow-gray-200 hover:bg-black transition-all">‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>` 
                            : `<button onclick="window.updateOrderStatus('${order.id}', 'completed')" class="flex-1 bg-green-600 text-white py-4 rounded-[24px] font-black shadow-lg shadow-green-100 hover:bg-green-700 transition-all flex items-center justify-center gap-2"><i data-lucide="check" class="w-5 h-5"></i> ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÅ‡∏•‡πâ‡∏ß</button>`}
                        <button onclick="if(confirm('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ?')) window.updateOrderStatus('${order.id}', 'completed')" class="p-4 bg-gray-50 text-gray-400 rounded-[24px] hover:text-red-500 hover:bg-red-50 transition-all"><i data-lucide="trash-2" class="w-6 h-6"></i></button>
                    </div>
                    
                    ${isPending ? `<div class="absolute -right-10 -bottom-10 w-40 h-40 bg-red-50 rounded-full opacity-50 z-0 pointer-events-none group-hover:scale-150 transition-transform duration-500"></div>` : ''}
                </div>`;
            }).join(''); 
            if(window.lucide) lucide.createIcons();
        }

        window.updateOrderStatus = async (id, newStatus) => {
            if (!db) {
                const order = allOrders.find(o => o.id === id); 
                if (order) order.status = newStatus;
                renderAdminOrders(allOrders); updateAccountingSummary(); return;
            }
            await updateDoc(doc(ordersCollection, id), { status: newStatus });
        };

        window.switchAdminTab = (tab) => {
            const sections = ['orders', 'menu', 'accounting', 'qr'];
            sections.forEach(s => {
                document.getElementById(`section-${s}`).classList.add('hidden');
                const btn = document.getElementById(`admin-tab-${s}`);
                // Reset styles
                btn.classList.remove('bg-red-600', 'text-white', 'shadow-md');
                btn.classList.add('bg-gray-50', 'text-gray-500', 'hover:bg-gray-100');
            });
            document.getElementById(`section-${tab}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`admin-tab-${tab}`);
            activeBtn.classList.add('bg-red-600', 'text-white', 'shadow-md');
            activeBtn.classList.remove('bg-gray-50', 'text-gray-500', 'hover:bg-gray-100');
            if(window.lucide) lucide.createIcons();
        };

        // --- Menu Management ---
        window.renderAdminMenu = () => {
            const list = document.getElementById('admin-menu-list');
            list.innerHTML = menuItems.map(item => `
                <div class="bg-white p-4 rounded-[32px] flex gap-4 shadow-sm border border-gray-50 items-center group hover:border-blue-100 transition-all">
                    <img src="${item.img}" class="w-16 h-16 rounded-2xl object-cover bg-gray-100 group-hover:scale-105 transition-transform">
                    <div class="flex-1">
                        <h4 class="font-black text-gray-700 leading-tight">${item.name}</h4>
                        <span class="text-red-600 font-black">‡∏ø${item.price}</span>
                        <span class="text-[10px] text-gray-400 font-bold uppercase ml-2 px-2 py-0.5 bg-gray-50 rounded-full">${item.cat}</span>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="window.editItem('${item.id}')" class="p-3 bg-blue-50 text-blue-600 rounded-xl active:scale-90 transition-all hover:bg-blue-100"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                        <button onclick="window.deleteItem('${item.id}')" class="p-3 bg-red-50 text-red-600 rounded-xl active:scale-90 transition-all hover:bg-red-100"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>`).join(''); 
            if(window.lucide) lucide.createIcons();
        };

        window.handleImageUpload = (input) => {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader(); 
            reader.onload = (e) => {
                const preview = document.getElementById('image-preview'); 
                const placeholder = document.getElementById('upload-placeholder');
                const imgDataInput = document.getElementById('menu-img-data'); 
                preview.src = e.target.result; 
                preview.classList.remove('hidden'); 
                placeholder.classList.add('hidden'); 
                imgDataInput.value = e.target.result;
            }; 
            reader.readAsDataURL(file);
        };

        window.editItem = (id) => { 
            const item = menuItems.find(i => i.id === id); 
            if (item) { 
                document.getElementById('edit-id').value = item.id; 
                document.getElementById('menu-name').value = item.name; 
                document.getElementById('menu-price').value = item.price; 
                document.getElementById('menu-cat').value = item.cat; 
                
                const preview = document.getElementById('image-preview'); 
                const placeholder = document.getElementById('upload-placeholder'); 
                preview.src = item.img; 
                preview.classList.remove('hidden'); 
                placeholder.classList.add('hidden'); 
                document.getElementById('menu-img-data').value = item.img; // Use existing img if not changed
                
                document.getElementById('form-submit').innerText = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"; 
                document.getElementById('form-submit').classList.replace('bg-gray-900', 'bg-blue-600');
                
                // Switch tab and scroll
                switchAdminTab('menu'); 
                document.getElementById('section-menu').scrollIntoView({ behavior: 'smooth' });
            } 
        };
        
        window.resetForm = () => { 
            document.getElementById('menu-form').reset(); 
            document.getElementById('edit-id').value = ""; 
            document.getElementById('menu-img-data').value = ""; 
            document.getElementById('image-preview').classList.add('hidden'); 
            document.getElementById('upload-placeholder').classList.remove('hidden'); 
            document.getElementById('form-submit').innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"; 
            document.getElementById('form-submit').classList.replace('bg-blue-600', 'bg-gray-900');
        };
        
        document.getElementById('menu-form').onsubmit = async (e) => { 
            e.preventDefault(); 
            if (!db) { alert("‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); window.resetForm(); return; }
            
            const id = document.getElementById('edit-id').value; 
            const img = document.getElementById('menu-img-data').value; 
            
            if (!img && !id) { alert("‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡∏à‡πâ‡∏≤!"); return; } 
            
            const data = { 
                name: document.getElementById('menu-name').value, 
                price: parseInt(document.getElementById('menu-price').value), 
                cat: document.getElementById('menu-cat').value, 
                desc: '' 
            }; 
            
            if (img) data.img = img; 
            
            try { 
                id ? await setDoc(doc(menuCollection, id), data, { merge: true }) : await addDoc(menuCollection, data); 
                resetForm(); 
            } catch (err) { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); console.error(err); } 
        };

        window.deleteItem = async (id) => { 
            if (!db) { alert("‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå: ‡∏•‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); return; }
            if (confirm("‡∏à‡∏∞‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏´‡∏£‡∏∑‡∏≠?")) await deleteDoc(doc(menuCollection, id)); 
        };
        
        window.addExpense = async (event) => {
            event.preventDefault();
            if (!db) { alert("‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ"); return; }
            const title = document.getElementById('expense-title').value; 
            const amount = parseFloat(document.getElementById('expense-amount').value);
            if (!title || !amount) return;
            try { 
                await addDoc(transactionsCollection, { title, amount, type: 'expense', timestamp: Date.now() }); 
                document.getElementById('expense-form').reset(); 
            } catch (e) { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }
        };
        document.getElementById('expense-form').onsubmit = window.addExpense;
        
        window.deleteTransaction = async (id) => { 
            if (!db) { alert("‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ"); return; }
            if (confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) await deleteDoc(doc(transactionsCollection, id)); 
        };
        
        window.exportToCSV = () => {
            const completedOrders = allOrders.filter(o => o.status === 'completed');
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
            csvContent += "--- ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ---\n‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î,‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î,‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥\n";
            const income = completedOrders.reduce((sum, o) => sum + o.total, 0);
            const expense = transactions.reduce((sum, t) => sum + t.amount, 0);
            const profit = income - expense;
            csvContent += `${income},${expense},${profit}\n\n`;
            
            csvContent += "--- ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡πÄ‡∏°‡∏ô‡∏π ---\n‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ä‡∏¥‡πâ‡∏ô/‡πÅ‡∏Å‡πâ‡∏ß),‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)\n";
            const itemStats = {};
            completedOrders.forEach(order => {
                order.items.forEach(item => {
                    if (!itemStats[item.name]) itemStats[item.name] = { qty: 0, total: 0 };
                    itemStats[item.name].qty += item.qty;
                    itemStats[item.name].total += (item.price * item.qty);
                });
            });
            Object.keys(itemStats).sort((a, b) => itemStats[b].qty - itemStats[a].qty).forEach(name => { 
                csvContent += `"${name}",${itemStats[name].qty},${itemStats[name].total}\n`; 
            });
            
            csvContent += "\n--- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ---\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)\n";
            transactions.forEach(t => { 
                const date = new Date(t.timestamp).toLocaleString('th-TH'); 
                csvContent += `"${date}","${t.title}",${t.amount}\n`; 
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a"); 
            link.setAttribute("href", encodedUri); 
            link.setAttribute("download", `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏°‡∏≤‡∏•‡πà‡∏≤_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.csv`);
            document.body.appendChild(link); 
            link.click(); 
            document.body.removeChild(link);
        };

        // --- QR Logic ---
        window.updateQRPreview = () => {
             const tableVal = document.getElementById('qr-table-input').value || "01";
             let baseUrl = document.getElementById('qr-base-url').value;
             
             // Auto-detect base URL if empty
             if (!baseUrl) {
                 baseUrl = window.location.href.split('?')[0];
                 document.getElementById('qr-base-url').placeholder = baseUrl; // Show hint
             }
             
             if(baseUrl.endsWith('/')) baseUrl = baseUrl.slice(0, -1);
             if(!baseUrl.startsWith('http')) baseUrl = 'http://' + baseUrl;

             const targetUrl = `${baseUrl}?table=${encodeURIComponent(tableVal)}`;
             const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(targetUrl)}`;
             
             document.getElementById('qr-image-preview').src = qrUrl;
             document.getElementById('preview-table-no').innerText = `‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà ${tableVal}`;
        }
        
        window.simulateScan = () => {
            const tableVal = "01"; // Default since input is gone
            tableNo = tableVal;
            document.getElementById('display-table-no').innerText = `‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà ${tableNo}`;
            
            // Remove Nav to simulate real customer experience
            const nav = document.getElementById('main-nav');
            if(nav) nav.remove();
            
            switchView('customer');
            
            try {
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('table', tableVal);
                window.history.pushState({}, '', newUrl);
            } catch (e) {}
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- Print Logic ---
        window.printQRCard = () => {
            const content = document.getElementById('card-preview-container').innerHTML;
            const printArea = document.getElementById('print-area');
            printArea.innerHTML = content;
            setTimeout(() => {
                window.print();
                // Clear after print to avoid interference with other prints if any
                // printArea.innerHTML = ''; 
            }, 500);
        }

        window.printOrderReceipt = (id) => {
            const order = allOrders.find(o => o.id === id);
            if(!order) return;

            const printArea = document.getElementById('print-area');
            const itemsHtml = order.items.map(i => `
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <div style="flex: 1;">
                        <span>${i.qty}x ${i.name}</span>
                        ${i.spice ? `<span style="font-size: 10px; margin-left: 4px;">(${i.spice})</span>` : ''}
                        ${i.note ? `<div style="font-size: 10px; color: #666;">* ${i.note}</div>` : ''}
                    </div>
                    <span>${(i.price * i.qty).toLocaleString()}</span>
                </div>
            `).join('');

            const receiptHtml = `
                <div style="width: 100%; max-width: 80mm; padding: 10px; font-family: 'Courier New', monospace; font-size: 12px; color: black; box-sizing: border-box;">
                    <div style="text-align: center; margin-bottom: 10px;">
                        <h2 style="font-size: 16px; font-weight: bold; margin: 0;">‡∏´‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏•‡∏¥‡πâ‡∏ô‡∏ä‡∏≤</h2>
                        <p style="margin: 2px 0; font-size: 10px;">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô / ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    </div>
                    
                    <div style="margin-bottom: 10px; border-bottom: 1px dashed black; padding-bottom: 5px;">
                        <p style="margin: 2px 0;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date(order.timestamp).toLocaleString('th-TH')}</p>
                        <p style="margin: 2px 0; font-weight: bold;">‡πÇ‡∏ï‡πä‡∏∞: ${order.table} <span style="float: right;">‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà: ${order.queueNo}</span></p>
                    </div>
                    
                    <div style="border-bottom: 1px dashed black; padding-bottom: 5px; margin-bottom: 5px;">
                        ${itemsHtml}
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; margin-bottom: 10px;">
                        <span>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span>
                        <span>‡∏ø${order.total.toLocaleString()}</span>
                    </div>
                    
                    <div style="text-align: center; font-size: 10px;">
                        ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£<br>Thank you
                    </div>
                </div>
            `;

            printArea.innerHTML = receiptHtml;
            setTimeout(() => {
                window.print();
            }, 500);
        }

        window.closeSuccess = () => { 
            document.getElementById('success-content').classList.add('scale-90', 'opacity-0'); 
            setTimeout(() => { document.getElementById('success-modal').classList.add('hidden'); window.toggleCart(); }, 400); 
        };
        
        window.showSuccess = () => { 
            const modal = document.getElementById('success-modal'); 
            const content = document.getElementById('success-content'); 
            modal.classList.remove('hidden'); 
            setTimeout(() => content.classList.add('scale-100', 'opacity-100'), 10); 
        }

        // Initialize App
        initApp();

    </script>
</body>
</html>
