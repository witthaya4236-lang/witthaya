<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏´‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏•‡∏¥‡πâ‡∏ô‡∏ä‡∏≤ & ‡∏ô‡πâ‡∏≥‡∏ä‡∏á - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Prompt', sans-serif; }
        .cart-drawer { transition: transform 0.3s ease-in-out; transform: translateY(100%); }
        .cart-drawer.open { transform: translateY(0); }
        .modal-animate { transition: all 0.3s ease-out; transform: scale(0.9); opacity: 0; }
        .modal-animate.show { transform: scale(1); opacity: 1; }
        .loading-shimmer {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
        .print-only { display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .new-order-pulse {
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        
        /* Custom Radio Button for Spice */
        .spice-radio:checked + label {
            background-color: #fef2f2;
            border-color: #ef4444;
            color: #b91c1c;
        }

        /* ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á QR Code */
        #qr-image img, #print-qr img {
            margin: auto;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-bold">

    <!-- Navigation Tab -->
    <div id="main-nav" class="fixed top-0 left-0 right-0 z-[60] flex justify-center p-2 pointer-events-none no-print mt-2 transition-opacity duration-300">
        <div class="bg-black/80 backdrop-blur-md text-white rounded-full p-1 flex gap-1 pointer-events-auto shadow-xl border border-white/20">
            <button onclick="switchView('customer')" id="tab-customer" class="px-4 py-1.5 rounded-full text-xs font-bold transition-all bg-red-600">
                <i data-lucide="users" class="w-3 h-3 inline mr-1"></i> ‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
            </button>
            <button onclick="switchView('admin')" id="tab-admin" class="px-4 py-1.5 rounded-full text-xs font-bold transition-all">
                <i data-lucide="settings" class="w-3 h-3 inline mr-1"></i> ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
            </button>
        </div>
    </div>

    <!-- CUSTOMER VIEW -->
    <div id="customer-view" class="pt-10 no-print relative">
        <button onclick="exitCustomerMode()" id="exit-customer-btn" class="fixed bottom-4 left-4 z-30 p-3 bg-gray-200/50 text-gray-400 rounded-full hover:bg-red-600 hover:text-white transition-all hidden">
            <i data-lucide="key" class="w-4 h-4"></i>
        </button>

        <header class="bg-red-600 text-white p-4 sticky top-10 z-40 shadow-lg">
            <div class="max-w-md mx-auto flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold">‡∏´‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏•‡∏¥‡πâ‡∏ô‡∏ä‡∏≤ & ‡∏ô‡πâ‡∏≥‡∏ä‡∏á</h1>
                    <p class="text-xs text-red-100 flex items-center gap-1 font-bold">
                        <i data-lucide="map-pin" class="w-3 h-3"></i> <span id="display-table-no">‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà --</span>
                    </p>
                </div>
                <button onclick="toggleCart()" class="relative p-2 bg-white/20 rounded-full">
                    <i data-lucide="shopping-cart"></i>
                    <span id="cart-badge" class="hidden absolute -top-1 -right-1 bg-yellow-400 text-red-900 text-[10px] font-bold w-5 h-5 items-center justify-center rounded-full border-2 border-red-600">0</span>
                </button>
            </div>
        </header>

        <main class="max-w-md mx-auto pb-20">
            <!-- Promotion Banner -->
            <div class="p-4">
                <div class="bg-gradient-to-r from-red-600 to-orange-500 rounded-3xl p-6 text-white shadow-md relative overflow-hidden">
                    <div class="relative z-10">
                        <h2 class="text-2xl font-bold mb-1 text-white">‡∏´‡∏≠‡∏° ‡πÅ‡∏ã‡πà‡∏ö ‡πÄ‡∏ú‡πá‡∏î‡∏ä‡∏≤!</h2>
                        <p class="text-sm opacity-90 text-white">‡∏™‡∏±‡πà‡∏á‡πÄ‡∏•‡∏¢! ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏±‡∏ô‡πÑ‡∏ß ‡πÑ‡∏î‡πâ‡πÑ‡∏ß‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô</p>
                    </div>
                    <i data-lucide="flame" class="absolute -right-4 -bottom-4 w-24 h-24 text-white/10 rotate-12"></i>
                </div>
            </div>

            <!-- Category Selector -->
            <div class="flex gap-2 px-4 mb-4 sticky top-[100px] bg-gray-50/95 backdrop-blur py-2 z-30 font-bold">
                <button onclick="filterMenu('mala')" id="btn-mala" class="flex-1 flex items-center justify-center gap-2 py-3 rounded-2xl bg-red-600 text-white shadow-sm transition-all active:scale-95">
                    <i data-lucide="flame" class="w-4 h-4"></i> ‡∏´‡∏°‡∏≤‡∏•‡πà‡∏≤
                </button>
                <button onclick="filterMenu('drinks')" id="btn-drinks" class="flex-1 flex items-center justify-center gap-2 py-3 rounded-2xl bg-white text-gray-500 border border-gray-100 shadow-sm transition-all active:scale-95">
                    <i data-lucide="coffee" class="w-4 h-4"></i> ‡∏ô‡πâ‡∏≥‡∏ä‡∏á
                </button>
            </div>

            <div id="menu-container" class="px-4 space-y-4">
                <div class="py-20 text-center text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏£‡πà‡∏≠‡∏¢...</div>
            </div>
        </main>
    </div>

    <!-- SELECTION MODAL -->
    <div id="selection-modal" class="fixed inset-0 z-[70] flex items-end sm:items-center justify-center p-0 sm:p-6 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeSelectionModal()"></div>
        <div class="bg-white rounded-t-[32px] sm:rounded-[32px] p-6 w-full max-w-sm relative z-10 modal-animate h-[85vh] sm:h-auto overflow-y-auto" id="selection-content">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6 sm:hidden"></div>
            <div class="flex gap-4 mb-6">
                <img id="modal-img" src="" class="w-24 h-24 rounded-2xl object-cover bg-gray-100 shadow-sm">
                <div>
                    <h3 id="modal-title" class="text-xl font-bold text-gray-800 leading-tight">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</h3>
                    <p id="modal-price" class="text-red-600 text-lg font-bold">‡∏ø0</p>
                </div>
            </div>
            <div id="modal-spice-section" class="mb-6 hidden">
                <label class="block text-sm font-bold text-gray-700 mb-3">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ú‡πá‡∏î <span class="text-red-500">*</span></label>
                <div class="space-y-2">
                    <input type="radio" name="spice" id="spice-no" value="‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î" class="hidden spice-radio" onchange="updateModalState()">
                    <label for="spice-no" class="flex items-center justify-between p-3 rounded-xl border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all">
                        <div class="flex items-center gap-2"><span class="w-4 h-4 rounded-full border-2 border-gray-300 flex items-center justify-center"><span class="w-2 h-2 rounded-full bg-red-500 hidden"></span></span> ‡πÑ‡∏°‡πà‡πÄ‡∏ú‡πá‡∏î</div><i data-lucide="sun" class="w-4 h-4 text-yellow-500"></i>
                    </label>
                    <input type="radio" name="spice" id="spice-mid" value="‡πÄ‡∏ú‡πá‡∏î‡∏Å‡∏•‡∏≤‡∏á" class="hidden spice-radio" onchange="updateModalState()">
                    <label for="spice-mid" class="flex items-center justify-between p-3 rounded-xl border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all">
                        <div class="flex items-center gap-2"><span class="w-4 h-4 rounded-full border-2 border-gray-300 flex items-center justify-center"><span class="w-2 h-2 rounded-full bg-red-500 hidden"></span></span> ‡πÄ‡∏ú‡πá‡∏î‡∏Å‡∏•‡∏≤‡∏á</div><i data-lucide="flame" class="w-4 h-4 text-orange-500"></i>
                    </label>
                    <input type="radio" name="spice" id="spice-high" value="‡πÄ‡∏ú‡πá‡∏î‡∏°‡∏≤‡∏Å" class="hidden spice-radio" onchange="updateModalState()">
                    <label for="spice-high" class="flex items-center justify-between p-3 rounded-xl border border-gray-200 cursor-pointer hover:bg-gray-50 transition-all">
                        <div class="flex items-center gap-2"><span class="w-4 h-4 rounded-full border-2 border-gray-300 flex items-center justify-center"><span class="w-2 h-2 rounded-full bg-red-500 hidden"></span></span> ‡πÄ‡∏ú‡πá‡∏î‡∏°‡∏≤‡∏Å</div><div class="flex"><i data-lucide="flame" class="w-4 h-4 text-red-600"></i><i data-lucide="flame" class="w-4 h-4 text-red-600"></i></div>
                    </label>
                </div>
            </div>
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-700 mb-2 flex justify-between">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°<span class="text-xs text-gray-400 font-normal">‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ú‡∏±‡∏Å, ‡∏´‡∏ß‡∏≤‡∏ô‡∏ô‡πâ‡∏≠‡∏¢</span></label>
                <textarea id="modal-note" rows="2" class="w-full p-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-red-500 outline-none text-sm bg-gray-50" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></textarea>
            </div>
            <div class="flex items-center justify-between gap-4 pt-4 border-t border-gray-100">
                <div class="flex items-center bg-gray-100 rounded-xl p-1">
                    <button onclick="adjustModalQty(-1)" class="w-10 h-10 flex items-center justify-center bg-white rounded-lg shadow-sm text-gray-600 hover:text-red-600 disabled:opacity-50"><i data-lucide="minus" class="w-4 h-4"></i></button>
                    <span id="modal-qty-display" class="w-10 text-center font-bold text-lg">1</span>
                    <button onclick="adjustModalQty(1)" class="w-10 h-10 flex items-center justify-center bg-white rounded-lg shadow-sm text-gray-600 hover:text-green-600"><i data-lucide="plus" class="w-4 h-4"></i></button>
                </div>
                <button onclick="confirmSelection()" id="modal-add-btn" class="flex-1 bg-red-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-red-200 active:scale-95 transition-all flex justify-center items-center gap-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ - ‡∏ø<span id="modal-total-price">0</span></button>
            </div>
        </div>
    </div>

    <!-- PAYMENT QR MODAL -->
    <div id="payment-modal" class="fixed inset-0 z-[80] flex items-center justify-center p-6 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-md" onclick="closePaymentModal()"></div>
        <div class="bg-white rounded-[40px] p-8 w-full max-w-sm relative z-10 modal-animate text-center" id="payment-content">
            <div class="mb-4"><h3 class="text-2xl font-black text-gray-800">‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</h3><p class="text-gray-400 text-sm font-bold">PromptPay QR Code</p></div>
            <div class="bg-blue-50 p-4 rounded-3xl border-4 border-blue-100 mb-6 relative overflow-hidden">
                <img id="payment-qr-image" src="" alt="PromptPay QR" class="w-48 h-48 mx-auto mix-blend-multiply">
                <div class="absolute top-2 right-2 bg-blue-600 text-white text-[10px] px-2 py-1 rounded-full font-bold">AUTO GEN</div>
            </div>
            <div class="mb-8"><p class="text-gray-500 text-sm font-bold mb-1">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p><p id="payment-total-amount" class="text-4xl font-black text-blue-600">‡∏ø0.00</p></div>
            <div class="space-y-3">
                <button onclick="submitOrder()" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-black text-lg shadow-lg shadow-blue-200 active:scale-95 transition-all flex items-center justify-center gap-2"><i data-lucide="check-circle-2"></i> ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</button>
                <button onclick="closePaymentModal()" class="w-full py-4 text-gray-400 font-bold text-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
            </div>
        </div>
    </div>

    <!-- ADMIN VIEW -->
    <div id="admin-view" class="hidden pt-16 max-w-5xl mx-auto p-4 no-print">
        <!-- Admin Navigation -->
        <div class="flex gap-2 mb-6 bg-white p-2 rounded-3xl shadow-sm overflow-x-auto no-scrollbar">
            <button onclick="switchAdminTab('orders')" id="admin-tab-orders" class="min-w-[120px] flex-1 py-3 rounded-2xl font-bold text-xs flex items-center justify-center gap-1 bg-red-600 text-white shadow-md transition-all"><i data-lucide="clipboard-list" class="w-4 h-4"></i> ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå/‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß<span id="order-count-badge" class="hidden bg-white text-red-600 px-2 rounded-full text-[10px]">0</span></button>
            <button onclick="switchAdminTab('accounting')" id="admin-tab-accounting" class="min-w-[120px] flex-1 py-3 rounded-2xl font-bold text-xs flex items-center justify-center gap-1 bg-gray-50 text-gray-500"><i data-lucide="pie-chart" class="w-4 h-4"></i> ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ/‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
            <button onclick="switchAdminTab('menu')" id="admin-tab-menu" class="min-w-[120px] flex-1 py-3 rounded-2xl font-bold text-xs flex items-center justify-center gap-1 bg-gray-50 text-gray-500"><i data-lucide="layout-grid" class="w-4 h-4"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</button>
            <button onclick="switchAdminTab('qr')" id="admin-tab-qr" class="min-w-[120px] flex-1 py-3 rounded-2xl font-bold text-xs flex items-center justify-center gap-1 bg-gray-50 text-gray-500"><i data-lucide="qr-code" class="w-4 h-4"></i> QR ‡πÇ‡∏ï‡πä‡∏∞</button>
        </div>

        <!-- Section: Orders -->
        <div id="section-orders" class="space-y-4">
            <div class="flex justify-between items-center mb-6">
                <div><h2 class="text-3xl font-black text-gray-800 uppercase tracking-tighter">‡∏Ñ‡∏£‡∏±‡∏ß & ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß</h2><p class="text-xs text-gray-400">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏±‡πà‡∏á (‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î)</p></div>
                <button onclick="window.testSound()" class="p-3 bg-white border border-gray-100 rounded-2xl shadow-sm text-gray-400 hover:text-red-500 transition-all active:scale-90"><i data-lucide="volume-2"></i></button>
            </div>
            <div id="orders-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- Section: Accounting -->
        <div id="section-accounting" class="hidden space-y-6">
            <div class="bg-blue-50 rounded-[40px] p-8 border-2 border-blue-100 mb-6">
                <h3 class="text-lg font-bold text-blue-800 mb-4 flex items-center gap-2"><i data-lucide="qr-code" class="w-5 h-5"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (PromptPay)</h3>
                <div class="flex gap-2"><input type="text" id="shop-promptpay-id" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä." class="flex-1 px-5 py-3 rounded-2xl border-none shadow-sm outline-none focus:ring-2 ring-blue-400 font-bold" onchange="savePromptPayID()"><button onclick="savePromptPayID()" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-bold shadow-md active:scale-95">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
                <p class="text-xs text-blue-400 mt-2 font-bold">* ‡πÉ‡∏™‡πà‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
            </div>
            <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gray-800">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h2><button onclick="window.exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded-2xl text-xs font-bold flex items-center gap-2 shadow-sm hover:bg-green-700 active:scale-95 transition-all"><i data-lucide="download" class="w-4 h-4"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (CSV)</button></div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-8 rounded-[40px] shadow-sm border border-gray-100"><p class="text-gray-400 text-xs font-bold uppercase mb-2">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÅ‡∏•‡πâ‡∏ß)</p><p id="total-income" class="text-4xl font-black text-green-600">‡∏ø0</p></div>
                <div class="bg-white p-8 rounded-[40px] shadow-sm border border-gray-100"><p class="text-gray-400 text-xs font-bold uppercase mb-2">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</p><p id="total-expense" class="text-4xl font-black text-red-600">‡∏ø0</p></div>
                <div class="bg-white p-8 rounded-[40px] shadow-sm border border-gray-100"><p class="text-gray-400 text-xs font-bold uppercase mb-2">‡∏Å‡∏≥‡πÑ‡∏£</p><p id="total-profit" class="text-4xl font-black text-blue-600">‡∏ø0</p></div>
            </div>
            <div class="bg-white rounded-[40px] shadow-sm border border-gray-100 p-8"><h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i data-lucide="plus-circle" class="text-red-600"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h3><form id="expense-form" class="flex flex-col md:flex-row gap-3"><input type="text" id="expense-title" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" class="flex-1 px-5 py-3 rounded-2xl border-2 border-gray-50 outline-none focus:border-red-500 font-bold" required><input type="number" id="expense-amount" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" class="w-full md:w-32 px-5 py-3 rounded-2xl border-2 border-gray-50 outline-none focus:border-red-500 font-bold" required><button type="submit" class="bg-gray-900 text-white px-8 py-3 rounded-2xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></form></div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-[40px] shadow-sm border border-gray-100 p-8 overflow-hidden"><h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i data-lucide="list" class="text-gray-800"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3><div class="overflow-y-auto max-h-80 no-scrollbar"><table class="w-full text-left font-bold text-sm"><thead><tr class="text-gray-400 text-[10px] border-b border-gray-50 font-black"><th class="pb-3">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th class="pb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th class="pb-3 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="pb-3"></th></tr></thead><tbody id="transaction-list"></tbody></table></div></div>
                <div class="bg-white rounded-[40px] shadow-sm border border-gray-100 p-8 overflow-hidden"><h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i data-lucide="bar-chart-2" class="text-red-600"></i> ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡πÄ‡∏°‡∏ô‡∏π (‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÅ‡∏•‡πâ‡∏ß)</h3><div class="overflow-y-auto max-h-80 no-scrollbar"><table class="w-full text-left font-bold text-sm"><thead><tr class="text-gray-400 text-[10px] border-b border-gray-50 font-black"><th class="pb-3">‡πÄ‡∏°‡∏ô‡∏π</th><th class="pb-3 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th><th class="pb-3 text-right">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th></tr></thead><tbody id="sales-breakdown-list"></tbody></table></div></div>
            </div>
        </div>

        <!-- Section: QR -->
        <div id="section-qr" class="hidden space-y-6">
            <div class="bg-white rounded-[50px] shadow-sm border border-gray-100 p-12 text-center">
                <h2 class="text-2xl font-black text-gray-800 mb-8 flex items-center justify-center gap-2"><i data-lucide="qr-code" class="text-red-600"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå QR Code ‡πÅ‡∏¢‡∏Å‡πÇ‡∏ï‡πä‡∏∞</h2>
                <div class="max-w-md mx-auto mb-10 space-y-4">
                    <div>
                        <label class="text-[10px] font-black uppercase text-blue-500 mb-2 block flex items-center justify-center gap-1"><i data-lucide="globe" class="w-3 h-3"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ß‡πá‡∏ö (Base URL)</label>
                        <!-- AUTO-FILL INPUT VALUE with persistence logic -->
                        <input type="text" id="qr-base-url" placeholder="‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á URL ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥..." oninput="updateAdminQR()" class="w-full px-6 py-4 rounded-2xl border-2 border-white outline-none focus:border-blue-500 text-center text-sm font-bold text-blue-700 bg-white shadow-sm">
                        <div id="localhost-warning" class="hidden mt-2 flex items-center justify-center gap-1 text-[10px] text-red-500 font-bold bg-red-50 p-1 rounded-lg">
                            <i data-lucide="alert-triangle" class="w-3 h-3"></i> ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (Localhost)
                        </div>
                        <p class="text-[10px] text-gray-400 mt-2">* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Ç‡∏≠‡∏á Vercel ‡∏´‡∏£‡∏∑‡∏≠ IP ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</p>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-gray-400 mb-2 block">‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞</label>
                        <input type="text" id="qr-table-input" value="01" oninput="updateAdminQR()" class="w-full px-6 py-4 rounded-3xl border-4 border-gray-50 outline-none focus:border-red-500 text-center text-4xl font-black">
                    </div>
                </div>
                <!-- QR Container for qrcode.js -->
                <div class="bg-white p-6 rounded-[40px] inline-block mb-10 border-4 border-gray-100 shadow-xl relative group">
                    <div id="qr-image" class="w-56 h-56 mx-auto rounded-xl flex justify-center items-center overflow-hidden bg-white"></div>
                    <div class="absolute inset-0 flex items-center justify-center bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity rounded-[30px] pointer-events-none"></div>
                </div>
                
                <!-- Link Preview -->
                <div class="mb-8 p-4 bg-gray-50 rounded-2xl text-center">
                    <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô QR Code</p>
                    <a id="qr-link-text" href="#" target="_blank" class="text-blue-600 text-xs font-bold break-all hover:underline hover:text-blue-800 transition-colors">...</a>
                </div>

                <div class="flex flex-col sm:flex-row gap-2 justify-center">
                    <button onclick="window.print()" class="bg-gray-900 text-white px-8 py-4 rounded-2xl font-bold flex items-center gap-2 mx-auto shadow-lg hover:bg-black transition-all"><i data-lucide="printer"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡πâ‡∏≤‡∏¢‡πÇ‡∏ï‡πä‡∏∞</button>
                    <!-- Removed the simulateScan button -->
                </div>
            </div>
        </div>

        <!-- Section: Menu -->
        <div id="section-menu" class="hidden space-y-6">
            <div class="bg-white rounded-[40px] shadow-sm border border-gray-100 p-10"><h2 class="text-2xl font-black text-gray-800 mb-8">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</h2><form id="menu-form" class="space-y-4 bg-gray-50 p-8 rounded-[32px] border-2 border-white shadow-sm"><input type="hidden" id="edit-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="md:col-span-2 flex flex-col items-center justify-center p-6 border-4 border-dashed border-white rounded-[32px] bg-white hover:border-red-200 cursor-pointer transition-all" onclick="document.getElementById('menu-file').click()"><input type="file" id="menu-file" accept="image/*" class="hidden" onchange="handleImageUpload(this)"><input type="hidden" id="menu-img-data"><img id="image-preview" src="" class="hidden w-40 h-40 object-cover rounded-[24px] mb-4 shadow-md"><div id="upload-placeholder" class="text-center"><i data-lucide="image-plus" class="w-10 h-10 mx-auto text-gray-200"></i><p class="text-xs font-black text-gray-300 mt-2 uppercase tracking-tighter">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡πÄ‡∏°‡∏ô‡∏π</p></div></div><input type="text" id="menu-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π" class="w-full px-6 py-4 rounded-2xl border-none shadow-inner bg-white outline-none focus:ring-4 ring-red-50" required><input type="number" id="menu-price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" class="w-full px-6 py-4 rounded-2xl border-none shadow-inner bg-white outline-none focus:ring-4 ring-red-50" required><select id="menu-cat" class="w-full px-6 py-4 rounded-2xl border-none shadow-inner bg-white outline-none focus:ring-4 ring-red-50 font-black"><option value="mala">‡∏´‡∏°‡∏≤‡∏•‡πà‡∏≤</option><option value="drinks">‡∏ô‡πâ‡∏≥‡∏ä‡∏á</option></select><button type="submit" id="form-submit" class="bg-gray-900 text-white font-black py-4 rounded-2xl hover:bg-black transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button></div></form></div><div id="admin-menu-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
    </div>

    <!-- Print Template -->
    <div class="print-only p-20 text-center">
        <div class="border-[12px] border-red-600 rounded-[100px] p-20 inline-block bg-white shadow-2xl"><h1 class="text-7xl font-black text-red-600 mb-2 uppercase italic tracking-tighter underline">‡∏´‡∏°‡∏≤‡∏•‡πà‡∏≤‡∏•‡∏¥‡πâ‡∏ô‡∏ä‡∏≤</h1><p class="text-2xl text-gray-400 mb-12 font-bold tracking-[0.5em] uppercase">MALA LIN CHA</p><div class="bg-white p-8 inline-block border-2 border-gray-100 rounded-[60px] shadow-sm mb-12">
            <!-- QR Container for Print -->
            <div id="print-qr" class="w-80 h-80 mx-auto bg-white flex justify-center items-center"></div>
        </div><div class="bg-red-600 text-white rounded-full py-6 px-20 inline-block shadow-lg"><p id="print-table-no" class="text-7xl font-black">‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà 01</p></div><p class="mt-12 text-gray-300 font-black text-xl tracking-widest">SCAN TO ORDER ‚Ä¢ ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á</p></div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-6 hidden no-print"><div class="absolute inset-0 bg-black/70 backdrop-blur-md"></div><div class="bg-white rounded-[60px] p-12 text-center relative z-10 w-full max-w-xs scale-90 opacity-0 transition-all duration-500" id="success-content"><div class="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-8 shadow-inner"><i data-lucide="check" class="w-12 h-12"></i></div><h4 class="text-3xl font-black mb-1 text-gray-800">‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß!</h4><div class="bg-red-600 text-white rounded-3xl py-4 my-6 shadow-lg"><p class="text-xs font-bold uppercase opacity-80 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p><p id="customer-queue-no" class="text-6xl font-black">#--</p></div><p class="text-gray-400 text-sm font-bold mb-8 italic" id="success-note-text">‡πÄ‡∏ä‡∏ü‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏≥‡∏à‡πâ‡∏≤<br>‡∏£‡∏≠‡∏ü‡∏±‡∏á‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!</p><button onclick="closeSuccess()" class="w-full py-5 bg-gray-900 text-white rounded-[32px] font-black text-xl active:scale-95 transition-all">‡∏ï‡∏Å‡∏•‡∏á</button></div></div>

    <!-- Cart Drawer -->
    <div id="cart-overlay" onclick="toggleCart()" class="fixed inset-0 bg-black/50 z-40 hidden opacity-0 transition-opacity no-print"></div>
    <div id="cart-drawer" class="cart-drawer fixed bottom-0 left-0 right-0 bg-white z-50 rounded-t-[50px] max-h-[90vh] flex flex-col shadow-2xl no-print">
        <div class="p-10 overflow-y-auto font-bold">
            <div class="flex justify-between items-center mb-8"><h3 class="text-3xl font-black text-gray-800">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</h3><button onclick="toggleCart()" class="p-3 bg-gray-50 rounded-full"><i data-lucide="x" class="text-gray-400"></i></button></div>
            <div id="ai-assistant" class="mb-8 hidden"><div class="bg-purple-50 rounded-[40px] p-6 border-4 border-white shadow-sm"><div class="flex items-center gap-2 mb-4 text-purple-700 font-black text-xs uppercase tracking-widest"><i data-lucide="sparkles" class="w-4 h-4"></i> AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞</div><div class="flex flex-wrap gap-2 mb-4"><button onclick="askGemini('recommend')" class="text-[10px] bg-white text-purple-600 px-5 py-2.5 rounded-2xl shadow-sm border border-purple-100 font-black uppercase active:bg-purple-600 active:text-white transition-all">‚ú® ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°</button><button onclick="askGemini('describe')" class="text-[10px] bg-white text-purple-600 px-5 py-2.5 rounded-2xl shadow-sm border border-purple-100 font-black uppercase active:bg-purple-600 active:text-white transition-all">üî• ‡πÅ‡∏ã‡∏ß‡πÄ‡∏°‡∏ô‡∏π</button></div><div id="ai-response" class="text-xs text-gray-600 leading-relaxed bg-white/50 p-5 rounded-3xl hidden"></div><div id="ai-loading" class="hidden space-y-2"><div class="h-3 w-3/4 loading-shimmer rounded-full"></div></div></div></div>
            <div id="cart-items" class="space-y-4 mb-8"></div>
            <div id="cart-empty" class="text-center py-24 text-gray-300 font-black italic tracking-widest uppercase">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤...</div>
        </div>
        <div class="p-10 border-t-4 border-gray-50 bg-white"><div class="flex justify-between items-center mb-8"><span class="text-gray-400 font-black uppercase text-xs">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</span><span id="cart-total" class="text-4xl font-black text-red-600">‡∏ø0</span></div><button onclick="placeOrder()" id="checkout-btn" class="w-full bg-red-600 text-white py-6 rounded-[35px] font-black text-2xl shadow-2xl active:scale-95 transition-all">‡∏™‡∏±‡πà‡∏á‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢!</button></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, addDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        //  ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Database Config)
        //  ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ Firebase ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏î‡πâ
        // ==========================================
        const userFirebaseConfig = {
            apiKey: "AIzaSyBeZCptmHAfSF_CGpLKCPXatp0hvlVtYo8",
            authDomain: "malashop-45181.firebaseapp.com",
            projectId: "malashop-45181",
            storageBucket: "malashop-45181.firebasestorage.app",
            messagingSenderId: "1062060224698",
            appId: "1:1062060224698:web:badeadc3c963ca33861283",
            measurementId: "G-E19PFFEEWH"
        };

        // Setup Firebase safely
        let app, auth, db;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        try {
            let config;
            if (userFirebaseConfig.apiKey) {
                config = userFirebaseConfig;
            } else if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                config = JSON.parse(__firebase_config);
            }

            if (config) {
                app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Database Connected!");
            }
        } catch (error) { 
            console.warn("Offline Mode: ", error); 
        }

        let user = null;
        let menuItems = [];
        let allOrders = [];
        let transactions = [];
        let cart = [];
        let currentFilter = 'mala';
        let isInitialOrdersLoad = true;
        let shopPromptPayId = localStorage.getItem('promptPayId') || "";
        
        let currentModalItem = null;
        let modalQty = 1;
        let modalSpice = null;

        const urlParams = new URLSearchParams(window.location.search);
        let tableNo = urlParams.get('table') || "‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ñ‡∏≤‡∏ô‡πå‡πÄ‡∏ï‡∏≠‡∏£‡πå";
        
        const tableParam = urlParams.get('table');
        if (tableParam) {
            document.getElementById('main-nav').classList.add('hidden');
            document.getElementById('exit-customer-btn').classList.remove('hidden');
        }

        document.getElementById('display-table-no').innerText = `‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà ${tableNo}`;

        if (document.getElementById('shop-promptpay-id')) { document.getElementById('shop-promptpay-id').value = shopPromptPayId; }
        window.savePromptPayID = () => { const val = document.getElementById('shop-promptpay-id').value; shopPromptPayId = val; localStorage.setItem('promptPayId', val); alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏Ç‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏à‡πâ‡∏≤!"); }

        const playNotificationSound = () => {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
            oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); oscillator.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.5);
            gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            oscillator.connect(gainNode); gainNode.connect(audioCtx.destination); oscillator.start(); oscillator.stop(audioCtx.currentTime + 0.5);
        };
        window.testSound = () => playNotificationSound();

        // ---------------- INITIALIZATION ----------------
        const runInit = () => {
            renderMenu(); 
            renderAdminMenu(); 
            
            const savedOrders = localStorage.getItem('offline_orders');
            if (savedOrders) {
                allOrders = JSON.parse(savedOrders);
                renderAdminOrders(allOrders);
                updateAccountingSummary();
            }
            
            // --- AUTO DETECT URL ---
            const baseUrlInput = document.getElementById('qr-base-url');
            if(baseUrlInput) {
                let savedBaseUrl = localStorage.getItem('qr_base_url');
                const currentUrl = window.location.href.split('?')[0];

                const isProduction = window.location.hostname !== '127.0.0.1' && window.location.hostname !== 'localhost';
                const savedIsLocal = savedBaseUrl && (savedBaseUrl.includes('127.0.0.1') || savedBaseUrl.includes('localhost'));

                if (isProduction && savedIsLocal) {
                   savedBaseUrl = null; 
                }
                
                if (savedBaseUrl) {
                    baseUrlInput.value = savedBaseUrl;
                } else {
                    // Default to current URL or the one you want
                    if (window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost' || window.location.protocol === 'file:') {
                        baseUrlInput.value = "http://192.168.1.42:5500/index.html"; 
                    } else {
                        baseUrlInput.value = window.location.href.split('?')[0]; 
                    }
                }
            }
            
            window.updateAdminQR(); 
            if(window.lucide) lucide.createIcons();
        };

        const initAuth = async () => {
            try {
                if (userFirebaseConfig.apiKey) {
                    await signInAnonymously(auth);
                } else if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Authentication Error:", err);
                if (auth) await signInAnonymously(auth).catch(e => console.error("Fallback failed", e));
            }
        };

        if (!db) {
            document.getElementById('local-warning').classList.remove('hidden');
            
            window.addEventListener('storage', (e) => {
                if (e.key === 'offline_orders') {
                    allOrders = JSON.parse(e.newValue || '[]');
                    renderAdminOrders(allOrders);
                    updateAccountingSummary();
                    playNotificationSound();
                }
            });

            menuItems = [
                { id: '1', cat: 'mala', name: '‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠‡∏´‡∏°‡∏π', price: 15, img: 'https://images.unsplash.com/photo-1544025162-d76694265947?w=400', desc: '‡∏´‡∏°‡∏π‡∏ô‡∏∏‡πà‡∏°' },
                { id: '2', cat: 'mala', name: '‡πÄ‡∏ö‡∏Ñ‡∏≠‡∏ô‡∏û‡∏±‡∏ô‡πÄ‡∏´‡πá‡∏î', price: 20, img: 'https://images.unsplash.com/photo-1603360946369-dc9bb6258143?w=400', desc: '‡∏≠‡∏£‡πà‡∏≠‡∏¢' },
                { id: '3', cat: 'drinks', name: '‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢', price: 45, img: 'https://images.unsplash.com/photo-1576092768241-dec231879fc3?w=400', desc: '‡∏´‡∏≠‡∏°' }
            ];
            
            setTimeout(runInit, 100);
            
        } else {
            initAuth();
            onAuthStateChanged(auth, (u) => { 
                user = u; 
                if (user) { 
                    setupRealtimeMenu(); 
                    setupRealtimeOrders(); 
                    setupRealtimeAccounting();
                    runInit(); 
                } 
            });
        }

        let menuCollection, ordersCollection, transactionsCollection;
        if (db) {
            menuCollection = collection(db, 'artifacts', appId, 'public', 'data', 'menu');
            ordersCollection = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
            transactionsCollection = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
        }

        function setupRealtimeMenu() {
            onSnapshot(menuCollection, (snapshot) => {
                menuItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (menuItems.length === 0) seedDefaultData();
                renderMenu(); renderAdminMenu();
            }, (error) => console.error("Menu DB error:", error));
        }

        function setupRealtimeOrders() {
            onSnapshot(ordersCollection, (snapshot) => {
                const newOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.timestamp - b.timestamp);
                if (!isInitialOrdersLoad) {
                    const hasNewPending = snapshot.docChanges().some(change => change.type === "added" && change.doc.data().status === 'pending');
                    if (hasNewPending) playNotificationSound();
                }
                isInitialOrdersLoad = false; allOrders = newOrders; renderAdminOrders(allOrders); updateAccountingSummary();
                const pendingCount = allOrders.filter(o => o.status === 'pending').length;
                const badge = document.getElementById('order-count-badge');
                if (pendingCount > 0) { badge.innerText = pendingCount; badge.classList.remove('hidden'); } else badge.classList.add('hidden');
            }, (error) => console.error("Orders DB error:", error));
        }

        function setupRealtimeAccounting() {
            onSnapshot(transactionsCollection, (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => b.timestamp - a.timestamp);
                updateAccountingSummary();
            }, (error) => console.error("Accounting DB error:", error));
        }

        async function seedDefaultData() {
            if (!db) return;
            const defaults = [ { cat: 'mala', name: '‡∏™‡∏±‡∏ô‡∏Ñ‡∏≠‡∏´‡∏°‡∏π', price: 15, img: 'https://images.unsplash.com/photo-1544025162-d76694265947?w=400', desc: '‡∏´‡∏°‡∏π‡∏ô‡∏∏‡πà‡∏°' }, { cat: 'drinks', name: '‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢', price: 45, img: 'https://images.unsplash.com/photo-1576092768241-dec231879fc3?w=400', desc: '‡∏´‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô' } ];
            for (const item of defaults) await addDoc(menuCollection, item);
        }

        function updateAccountingSummary() {
            const income = allOrders.filter(o => o.status === 'completed').reduce((sum, o) => sum + o.total, 0);
            const expense = transactions.reduce((sum, t) => sum + t.amount, 0);
            const profit = income - expense;
            document.getElementById('total-income').innerText = `‡∏ø${income.toLocaleString()}`;
            document.getElementById('total-expense').innerText = `‡∏ø${expense.toLocaleString()}`;
            document.getElementById('total-profit').innerText = `‡∏ø${profit.toLocaleString()}`;
            renderTransactionsList(income);
            const completedOrders = allOrders.filter(o => o.status === 'completed');
            const itemStats = {};
            completedOrders.forEach(order => {
                order.items.forEach(item => {
                    if (!itemStats[item.name]) itemStats[item.name] = { qty: 0, total: 0 };
                    itemStats[item.name].qty += item.qty;
                    itemStats[item.name].total += (item.price * item.qty);
                });
            });
            const sortedItems = Object.keys(itemStats).map(name => ({ name, qty: itemStats[name].qty, total: itemStats[name].total })).sort((a, b) => b.qty - a.qty);
            renderSalesBreakdown(sortedItems);
        }

        function renderSalesBreakdown(items) {
            const list = document.getElementById('sales-breakdown-list');
            if(items.length === 0) { list.innerHTML = `<tr><td colspan="3" class="text-center py-8 text-gray-400 font-bold">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</td></tr>`; return; }
            list.innerHTML = items.map(item => `<tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors text-gray-700"><td class="py-4">${item.name}</td><td class="py-4 text-center text-blue-600 font-black">${item.qty}</td><td class="py-4 text-right text-green-600 font-black">‡∏ø${item.total.toLocaleString()}</td></tr>`).join('');
            if(window.lucide) lucide.createIcons();
        }

        window.exportToCSV = () => {
            const completedOrders = allOrders.filter(o => o.status === 'completed');
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; 
            csvContent += "--- ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ---\n‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î,‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î,‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥\n";
            const income = completedOrders.reduce((sum, o) => sum + o.total, 0);
            const expense = transactions.reduce((sum, t) => sum + t.amount, 0);
            const profit = income - expense;
            csvContent += `${income},${expense},${profit}\n\n`;
            csvContent += "--- ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡πÄ‡∏°‡∏ô‡∏π ---\n‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ (‡∏ä‡∏¥‡πâ‡∏ô/‡πÅ‡∏Å‡πâ‡∏ß),‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)\n";
            const itemStats = {};
            completedOrders.forEach(order => {
                order.items.forEach(item => {
                    if (!itemStats[item.name]) itemStats[item.name] = { qty: 0, total: 0 };
                    itemStats[item.name].qty += item.qty;
                    itemStats[item.name].total += (item.price * item.qty);
                });
            });
            Object.keys(itemStats).sort((a, b) => itemStats[b].qty - itemStats[a].qty).forEach(name => { csvContent += `"${name}",${itemStats[name].qty},${itemStats[name].total}\n`; });
            csvContent += "\n--- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ---\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤,‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£,‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)\n";
            transactions.forEach(t => { const date = new Date(t.timestamp).toLocaleString('th-TH'); csvContent += `"${date}","${t.title}",${t.amount}\n`; });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏°‡∏≤‡∏•‡πà‡∏≤_${new Date().toLocaleDateString('th-TH').replace(/\//g, '-')}.csv`);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        async function addExpense(event) {
            event.preventDefault();
            if (!db) { alert("‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ"); return; }
            const title = document.getElementById('expense-title').value; const amount = parseFloat(document.getElementById('expense-amount').value);
            if (!title || !amount) return;
            try { await addDoc(transactionsCollection, { title, amount, type: 'expense', timestamp: Date.now() }); document.getElementById('expense-form').reset(); } catch (e) { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); }
        }
        document.getElementById('expense-form').onsubmit = addExpense;

        function renderTransactionsList(totalIncome) {
            const list = document.getElementById('transaction-list');
            const salesRow = `<tr class="border-b border-gray-50 bg-green-50/30 text-green-600 font-black"><td class="p-4">‚úÖ</td><td>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏°</td><td class="text-right">‡∏ø${totalIncome.toLocaleString()}</td><td></td></tr>`;
            const expenseRows = transactions.map(t => `<tr class="border-b border-gray-50 text-gray-700"><td class="p-4 font-black">üí∏</td><td>${t.title}</td><td class="text-right text-red-500">‡∏ø${t.amount.toLocaleString()}</td><td class="text-right"><button onclick="window.deleteTransaction('${t.id}')" class="text-gray-300 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`).join('');
            list.innerHTML = salesRow + expenseRows; if(window.lucide) lucide.createIcons();
        }

        window.deleteTransaction = async (id) => { 
            if (!db) { alert("‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ"); return; }
            if (confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) await deleteDoc(doc(transactionsCollection, id)); 
        };

        window.switchAdminTab = (tab) => {
            const sections = ['orders', 'menu', 'qr', 'accounting'];
            sections.forEach(s => {
                document.getElementById(`section-${s}`).classList.add('hidden');
                const btn = document.getElementById(`admin-tab-${s}`);
                btn.classList.remove('bg-red-600', 'text-white', 'shadow-md');
                btn.classList.add('bg-gray-50', 'text-gray-500');
            });
            document.getElementById(`section-${tab}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`admin-tab-${tab}`);
            activeBtn.classList.add('bg-red-600', 'text-white', 'shadow-md');
            activeBtn.classList.remove('bg-gray-50', 'text-gray-500');
            if(window.lucide) lucide.createIcons();
        };

        window.placeOrder = () => {
            if (cart.length === 0) return;
            const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            document.getElementById('payment-total-amount').innerText = `‡∏ø${total.toLocaleString()}`;
            const promptPayID = shopPromptPayId || "0800000000"; 
            const qrUrl = `https://promptpay.io/${promptPayID}/${total}.png`;
            document.getElementById('payment-qr-image').src = qrUrl;
            document.getElementById('payment-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('payment-content').classList.add('show'), 10);
        };

        window.closePaymentModal = () => {
            document.getElementById('payment-content').classList.remove('show');
            setTimeout(() => document.getElementById('payment-modal').classList.add('hidden'), 300);
        };

        window.submitOrder = async () => {
            window.closePaymentModal();
            const btn = document.getElementById('checkout-btn'); btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏Ñ‡∏¥‡∏ß..."; btn.disabled = true;
            let queueNo = 1;
            if (db) {
                try { const snapshot = await getDocs(ordersCollection); queueNo = snapshot.size + 1; } catch(e) { console.error(e); }
            } else { queueNo = Math.floor(Math.random() * 100) + 1; }
            const orderData = {
                queueNo: queueNo, table: tableNo,
                items: cart.map(i => ({ name: i.name, spice: i.spice || null, price: i.price, qty: i.qty, note: i.note || '' })),
                total: cart.reduce((sum, item) => sum + (item.price * item.qty), 0),
                status: 'pending', timestamp: Date.now()
            };
            try {
                if (db) {
                    await addDoc(ordersCollection, orderData);
                } else {
                    // OFFLINE SYNC LOGIC
                    allOrders.push({ id: Date.now().toString(), ...orderData });
                    localStorage.setItem('offline_orders', JSON.stringify(allOrders)); // Sync to other tabs
                    renderAdminOrders(allOrders);
                    document.getElementById('success-note-text').innerHTML = "‡πÇ‡∏´‡∏°‡∏î‡∏à‡∏≥‡∏•‡∏≠‡∏á: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏Ñ‡πà‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ<br>‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå";
                }
                document.getElementById('customer-queue-no').innerText = `#${queueNo}`;
                showSuccess(); cart = []; updateBadge();
            } catch (err) { alert("‡∏Ñ‡∏¥‡∏ß‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞"); } finally { btn.innerText = "‡∏™‡∏±‡πà‡∏á‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢!"; btn.disabled = false; }
        };

        window.updateOrderStatus = async (id, newStatus) => {
            if (!db) {
                const order = allOrders.find(o => o.id === id); if (order) order.status = newStatus;
                localStorage.setItem('offline_orders', JSON.stringify(allOrders)); // Sync Update
                renderAdminOrders(allOrders); updateAccountingSummary(); return;
            }
            await updateDoc(doc(ordersCollection, id), { status: newStatus });
        };

        function renderAdminOrders(orders) {
            const list = document.getElementById('orders-list');
            const activeOrders = orders.filter(o => o.status !== 'completed');
            if (activeOrders.length === 0) { list.innerHTML = `<div class="col-span-full py-20 text-center text-gray-400 font-black">‡∏Ñ‡∏£‡∏±‡∏ß‡∏ß‡πà‡∏≤‡∏á‡∏à‡πâ‡∏≤! ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</div>`; return; }
            list.innerHTML = activeOrders.map((order, index) => {
                const time = new Date(order.timestamp).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
                const isPending = order.status === 'pending';
                const isOverdue = (Date.now() - order.timestamp) > 300000;
                return `<div class="bg-white rounded-[45px] p-8 shadow-sm border-2 ${isPending ? 'border-red-500' : 'border-green-100'} ${isOverdue ? 'new-order-pulse' : ''} transition-all"><div class="flex justify-between items-start mb-6"><div class="bg-gray-900 text-white rounded-3xl py-1 px-4 text-xs font-black uppercase tracking-widest">${index === 0 ? 'üî• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü' : '‚è≥ ‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ'}</div><span class="text-3xl font-black text-red-600">#${order.queueNo || '--'}</span></div><div class="mb-6"><h3 class="text-3xl font-black text-gray-800">‡πÇ‡∏ï‡πä‡∏∞: ${order.table}</h3><p class="text-xs text-gray-400 font-bold">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${time}</p></div><div class="space-y-2 mb-8 border-y-2 border-gray-50 py-5 font-black">${order.items.map(i => `<div class="flex justify-between text-lg items-start"><div class="flex-1"><div class="flex items-center gap-2"><span class="text-gray-800">${i.qty}x ${i.name}</span>${i.spice ? `<span class="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full w-fit uppercase">${i.spice}</span>`:''}</div>${i.note ? `<p class="text-xs text-blue-600 mt-1 font-bold">üìù ${i.note}</p>` : ''}</div><span class="text-gray-300 text-xs whitespace-nowrap">‡∏ø${i.price*i.qty}</span></div>`).join('')}</div><div class="flex gap-2">${isPending ? `<button onclick="window.updateOrderStatus('${order.id}', 'cooking')" class="flex-1 bg-gray-900 text-white py-5 rounded-[28px] font-black shadow-lg shadow-gray-200">‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>` : `<button onclick="window.updateOrderStatus('${order.id}', 'completed')" class="flex-1 bg-green-600 text-white py-5 rounded-[28px] font-black shadow-lg shadow-green-100">‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ</button>`}<button onclick="if(confirm('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å?')) window.updateOrderStatus('${order.id}', 'completed')" class="p-5 bg-gray-50 text-gray-300 rounded-[28px] hover:text-red-500"><i data-lucide="trash-2" class="w-6 h-6"></i></button></div></div>`;
            }).join(''); if(window.lucide) lucide.createIcons();
        }

        window.switchView = (v) => {
            const cv = document.getElementById('customer-view'); const av = document.getElementById('admin-view');
            const tc = document.getElementById('tab-customer'); const ta = document.getElementById('tab-admin');
            
            // Show exit button only in customer view
            const exitBtn = document.getElementById('exit-customer-btn');
            
            if (v === 'admin') { 
                cv.classList.add('hidden'); av.classList.remove('hidden'); ta.classList.add('bg-red-600'); tc.classList.remove('bg-red-600'); 
                exitBtn.classList.add('hidden');
            }
            else { 
                cv.classList.remove('hidden'); av.classList.add('hidden'); tc.classList.add('bg-red-600'); ta.classList.remove('bg-red-600'); 
                exitBtn.classList.remove('hidden');
            }
        };
        
        window.exitCustomerMode = () => {
            // Restore Nav
            document.getElementById('main-nav').classList.remove('hidden');
            // Switch to Admin
            switchView('admin');
            // Reset URL params (Softly)
            const newUrl = window.location.href.split('?')[0];
            window.history.pushState({}, '', newUrl);
            document.getElementById('display-table-no').innerText = "‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà --";
        };

        window.handleImageUpload = (input) => {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader(); reader.onload = (e) => {
                const preview = document.getElementById('image-preview'); const placeholder = document.getElementById('upload-placeholder');
                const imgDataInput = document.getElementById('menu-img-data'); preview.src = e.target.result; preview.classList.remove('hidden'); placeholder.classList.add('hidden'); imgDataInput.value = e.target.result;
            }; reader.readAsDataURL(file);
        };

        window.filterMenu = (cat) => {
            currentFilter = cat; const btnMala = document.getElementById('btn-mala'); const btnDrinks = document.getElementById('btn-drinks');
            if (cat === 'mala') { btnMala.className = 'flex-1 flex items-center justify-center gap-2 py-3 rounded-2xl bg-red-600 text-white shadow-sm font-black transition-all'; btnDrinks.className = 'flex-1 flex items-center justify-center gap-2 py-3 rounded-2xl bg-white text-gray-500 border border-gray-100 shadow-sm font-black transition-all'; }
            else { btnDrinks.className = 'flex-1 flex items-center justify-center gap-2 py-3 rounded-2xl bg-red-600 text-white shadow-sm font-black transition-all'; btnMala.className = 'flex-1 flex items-center justify-center gap-2 py-3 rounded-2xl bg-white text-gray-500 border border-gray-100 shadow-sm font-black transition-all'; }
            renderMenu();
        };

        function renderMenu() {
            const container = document.getElementById('menu-container');
            const items = menuItems.filter(item => item.cat === currentFilter);
            if (items.length === 0) { container.innerHTML = `<div class="py-20 text-center text-gray-400 font-black italic uppercase">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</div>`; return; }
            container.innerHTML = items.map(item => `
                <div class="bg-white p-4 rounded-[35px] flex gap-5 shadow-sm border-2 border-gray-50 hover:border-red-100 transition-all cursor-pointer" onclick="window.openSelectionModal('${item.id}')">
                    <img src="${item.img}" class="w-28 h-28 rounded-[24px] object-cover bg-gray-100 shadow-inner">
                    <div class="flex-1 flex flex-col justify-between py-1">
                        <div><h4 class="font-black text-gray-800 text-xl tracking-tighter">${item.name}</h4><span class="text-red-600 font-black text-2xl">‡∏ø${item.price}</span></div>
                        <div class="self-end bg-gray-900 text-white p-4 rounded-2xl hover:bg-red-600 active:scale-90 transition-all shadow-md"><i data-lucide="plus" class="w-6 h-6 text-white"></i></div>
                    </div>
                </div>`).join(''); 
            if(window.lucide) lucide.createIcons();
        }

        window.openSelectionModal = (id) => {
            const product = menuItems.find(p => p.id === id); if (!product) return;
            currentModalItem = product; modalQty = 1; modalSpice = null;
            document.getElementById('modal-img').src = product.img;
            document.getElementById('modal-title').innerText = product.name;
            document.getElementById('modal-price').innerText = `‡∏ø${product.price}`;
            document.getElementById('modal-qty-display').innerText = "1";
            document.getElementById('modal-total-price').innerText = product.price;
            document.getElementById('modal-note').value = "";
            const spiceSection = document.getElementById('modal-spice-section');
            const spiceRadios = document.querySelectorAll('.spice-radio');
            spiceRadios.forEach(r => r.checked = false);
            if (product.cat === 'mala') spiceSection.classList.remove('hidden'); else spiceSection.classList.add('hidden');
            document.getElementById('selection-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('selection-content').classList.add('show'), 10);
            if(window.lucide) lucide.createIcons();
        };

        window.closeSelectionModal = () => { document.getElementById('selection-content').classList.remove('show'); setTimeout(() => { document.getElementById('selection-modal').classList.add('hidden'); currentModalItem = null; }, 300); };
        window.adjustModalQty = (delta) => { if (!currentModalItem) return; const newQty = modalQty + delta; if (newQty < 1) return; modalQty = newQty; document.getElementById('modal-qty-display').innerText = modalQty; document.getElementById('modal-total-price').innerText = (currentModalItem.price * modalQty).toLocaleString(); };
        window.updateModalState = () => { const radios = document.getElementsByName('spice'); for(let r of radios) { if(r.checked) modalSpice = r.value; } };

        window.confirmSelection = () => {
            if (!currentModalItem) return;
            if (currentModalItem.cat === 'mala') {
                const radios = document.getElementsByName('spice'); let selected = null; for(let r of radios) { if(r.checked) selected = r.value; }
                if (!selected) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ú‡πá‡∏î‡∏à‡πâ‡∏≤!"); return; } modalSpice = selected;
            } else { modalSpice = null; }
            const note = document.getElementById('modal-note').value.trim();
            const existing = cart.find(item => item.id === currentModalItem.id && item.spice === modalSpice && item.note === note);
            if (existing) existing.qty += modalQty; else cart.push({ ...currentModalItem, qty: modalQty, spice: modalSpice, note: note });
            updateBadge(); window.closeSelectionModal();
        };

        function updateBadge() { const badge = document.getElementById('cart-badge'); const total = cart.reduce((sum, item) => sum + item.qty, 0); if (total > 0) { badge.innerText = total; badge.classList.replace('hidden', 'flex'); } else badge.classList.replace('flex', 'hidden'); }
        window.toggleCart = () => { const drawer = document.getElementById('cart-drawer'); const overlay = document.getElementById('cart-overlay'); const isOpen = drawer.classList.contains('open'); if (isOpen) { drawer.classList.remove('open'); overlay.classList.add('hidden'); overlay.classList.remove('opacity-100'); } else { drawer.classList.add('open'); overlay.classList.remove('hidden'); setTimeout(() => overlay.classList.add('opacity-100'), 10); renderCart(); } };

        function renderCart() {
            const container = document.getElementById('cart-items'); const totalEl = document.getElementById('cart-total'); const ai = document.getElementById('ai-assistant'); if (cart.length === 0) { container.innerHTML = ''; document.getElementById('cart-empty').classList.remove('hidden'); ai.classList.add('hidden'); }
            else {
                document.getElementById('cart-empty').classList.add('hidden'); ai.classList.remove('hidden');
                container.innerHTML = cart.map((item, index) => `<div class="flex justify-between items-center bg-gray-50 p-5 rounded-[30px] border-2 border-white shadow-sm"><div class="flex items-center gap-4"><img src="${item.img}" class="w-16 h-16 rounded-[18px] object-cover shadow-sm"><div><p class="font-black text-gray-800 tracking-tighter">${item.name}</p><div class="flex flex-wrap gap-1 mt-1">${item.spice ? `<span class="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-black uppercase">${item.spice}</span>` : ''}${item.note ? `<span class="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold">üìù ${item.note}</span>` : ''}</div><p class="text-sm text-red-600 font-black mt-1">‡∏ø${item.price * item.qty}</p></div></div><div class="flex items-center gap-3 bg-white px-4 py-2 rounded-2xl shadow-inner font-black"><button onclick="window.updateQty(${index}, -1)"><i data-lucide="minus" class="w-4 h-4 text-gray-300"></i></button><span class="w-5 text-center text-lg">${item.qty}</span><button onclick="window.updateQty(${index}, 1)"><i data-lucide="plus" class="w-4 h-4 text-red-600"></i></button></div></div>`).join('');
            }
            totalEl.innerText = `‡∏ø${cart.reduce((sum, item) => sum + (item.price * item.qty), 0).toLocaleString()}`;
            if(window.lucide) lucide.createIcons();
        }

        window.updateQty = (index, delta) => { const item = cart[index]; if (item) { item.qty += delta; if (item.qty <= 0) cart.splice(index, 1); } renderCart(); updateBadge(); };

        // --- UPDATE ADMIN QR CODE (ALLOW CUSTOM URL) ---
        window.updateAdminQR = () => {
            const tableInput = document.getElementById('qr-table-input');
            const baseUrlInput = document.getElementById('qr-base-url');
            
            if (!tableInput) return; // Safety check

            const tableVal = tableInput.value || "01";
            
            // Get user provided base URL or use current
            let baseUrl = baseUrlInput ? baseUrlInput.value : "";
            
            if (!baseUrl) {
                baseUrl = window.location.href.split('?')[0];
            }
            
            // Ensure no trailing slash if params are added
            if(baseUrl.endsWith('/')) baseUrl = baseUrl.slice(0, -1);
            
            // Handle if user didn't put http
            if(!baseUrl.startsWith('http')) baseUrl = 'http://' + baseUrl;

            // Check if localhost
            if (baseUrl.includes('127.0.0.1') || baseUrl.includes('localhost')) {
                document.getElementById('localhost-warning').classList.remove('hidden');
            } else {
                document.getElementById('localhost-warning').classList.add('hidden');
            }
            
            // Save preference
            localStorage.setItem('qr_base_url', baseUrl);

            const targetUrl = `${baseUrl}?table=${encodeURIComponent(tableVal)}`;
            
            // Generate QR Code using qrcode.js (Client-side)
            const qrContainer = document.getElementById('qr-image');
            const printQrContainer = document.getElementById('print-qr');
            
            // Clear previous content
            if (qrContainer) qrContainer.innerHTML = "";
            if (printQrContainer) printQrContainer.innerHTML = "";
            
            try {
                // Admin View QR
                if (qrContainer) {
                    new QRCode(qrContainer, {
                        text: targetUrl,
                        width: 200,
                        height: 200,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                }
                
                // Print View QR
                if (printQrContainer) {
                    new QRCode(printQrContainer, {
                        text: targetUrl,
                        width: 320,
                        height: 320,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                }
            } catch (e) {
                console.error("QR Code Generation Error:", e);
                if (qrContainer) qrContainer.innerText = "Error generating QR";
            }
            
            // Update table number text
            const printTableNo = document.getElementById('print-table-no');
            if (printTableNo) printTableNo.innerText = `‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà ${tableVal}`;
            
            // Update link preview
            const linkText = document.getElementById('qr-link-text');
            if(linkText) {
                linkText.innerText = targetUrl;
                linkText.href = targetUrl;
            }
        }

        // REMOVED simulateScan function

        window.closeSuccess = () => { document.getElementById('success-content').classList.add('scale-90', 'opacity-0'); setTimeout
